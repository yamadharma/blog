---
title: "Emacs. Почта. Mu4e"
author: ["Dmitry S. Kulyabov"]
date: 2020-12-24T15:32:00+03:00
lastmod: 2022-08-30T11:49:00+03:00
tags: ["emacs"]
categories: ["computer-science"]
draft: false
slug: "emacs-mail-mu4e"
---

Mu4e --- режим для чтения почты в Emacs.

<!--more-->

{{< toc >}}


## <span class="section-num">1</span> Установка {#установка}

-   Клиент mu4e является интерфейсом к программе индексирования почты mu (URL: <https://www.djcbsoftware.nl/code/mu/>).
-   Поэтому вначале нужно установить эту программу.


### <span class="section-num">1.1</span> Gentoo {#gentoo}

```shell
USE="emacs" emerge -v mu
```


## <span class="section-num">2</span> Структура каталогов {#структура-каталогов}

Почтовые ящики будут находиться в каталоге `~/Maildir`.


## <span class="section-num">3</span> Получение почты {#получение-почты}

Для почты _mu_ поддерживает формат _maildir_[^fn:1].
Для скачивания почты можно использовать разные программы.

-   Для внешнего сервера IMAP или POP можно использовать такие инструменты, как _getmail_, _fetchmail_, _offlineimap_, _isync_, чтобы загрузить свои сообщения в формате _maildir_.
-   При использовании локального почтового сервера (_postfix_, _qmail_) настраивается сохранение сообщений в формате _maildir_.


### <span class="section-num">3.1</span> Синхронизация mbsync {#синхронизация-mbsync}

-   Для синхронизации будем использовать программу _mbsync_ (см. [Почта. Синхронизация. mbsync]({{< relref "2021-01-22-mail-synchronization-mbsync" >}})).


### <span class="section-num">3.2</span> Инициализация {#инициализация}

-   Перед использованием необходимо инициализировать базу данных писем:
    ```shell
    mu init --maildir=~/Maildir \
       --my-address=account1@domain1 \
       --my-address=account2@domain2
    ```
-   Можно это выполнить скриптом:
    ```shell
    #!/bin/sh

    list_imap=$(grep -e "^IMAPAccount" ~/.mbsyncrc | cut -d" " -f2 | xargs -I {} -n 1 echo "--my-address="{})
    mu init --maildir=~/Maildir $list_imap
    ```
-   Я использую скрипт, поскольку у меня кэш находится на временной файловой системе, и не сохраняется при перезагрузке.


### <span class="section-num">3.3</span> Индексирование почты {#индексирование-почты}

-   После загрузки писем необходимо инициализировать базу данных `mu` и про индексировать электрические письма:
    ```shell
    mu index
    ```


## <span class="section-num">4</span> Сочетания клавиш {#сочетания-клавиш}


### <span class="section-num">4.1</span> Передвижение по сообщениям {#передвижение-по-сообщениям}

-   Работают, когда Вы находитесь в режиме просмотра сообщения.

| Клавиши  | Описание                                                       |
|----------|----------------------------------------------------------------|
| `n`, `p` | просмотреть следующее, предыдущее сообщение                    |
| `]`, `[` | перейти к следующему, предыдущему непрочитанному сообщению     |
| `y`      | переключиться на список заголовков (и обратно)                 |
| `RET`    | прокрутить вниз                                                |
| `M-RET`  | открыть URL или вложение (в точке курсора)                     |
| `SPC`    | прокрутить вниз, если конец сообщения, то перейти к следующему |
| `S-SPC`  | прокрутить вверх                                               |


### <span class="section-num">4.2</span> Поиск {#поиск}

| Клавиши   | Описание                              |
|-----------|---------------------------------------|
| `s`       | поиск                                 |
| `S`       | редактировать последний запрос        |
| `/`       | сузить поиск                          |
| `b`       | поиск по закладке                     |
| `B`       | редактировать закладку перед поиском  |
| `j`       | перейти в конкретный почтовый каталог |
| `M-left`  | предыдущий запрос                     |
| `M-right` | следующий запрос                      |


### <span class="section-num">4.3</span> Маркировка сообщений {#маркировка-сообщений}

| Клавиши         | Описание                                         |
|-----------------|--------------------------------------------------|
| `d`             | отметка для отправки в корзину                   |
| `=`             | отметка для снятия отметки об отправке в корзину |
| `DEL`, `D`      | отметка для полного удаления                     |
| `m`             | отметка для отправки в другую почтовую папку     |
| `r`             | отметка для архивирования                        |
| `+`, `-`        | отметка для установки/снятия флага               |
| `u`             | снять отметку с сообщения                        |
| `U`             | снять отметку со всех сообщений                  |
| `%`             | отметка на основе регулярного выражения          |
| `T`, `t`        | отметить всю ветку/подветку                      |
| `<insert>`, `*` | отметить для отложенного действия                |
| `#`             | выполнить с отметкой для отложенного действия    |
| `x`             | выполнить действие для отмеченных сообщений      |


### <span class="section-num">4.4</span> Создание сообщения {#создание-сообщения}

| Клавиши       | Описание                                 |
|---------------|------------------------------------------|
| `R`, `F`, `C` | ответить/переслать/написать              |
| `E`           | редактировать (для черновиков сообщений) |


### <span class="section-num">4.5</span> Действия {#действия}

| Клавиши                 | Описание                                                    |
|-------------------------|-------------------------------------------------------------|
| `g`                     | перейти к пронумерованному URL (используя `browse-url`)     |
| `<mouse-1>` на URL      | перейти к пронумерованному URL (используя `browse-url`)     |
| `M-RET` на URL          | перейти к пронумерованному URL (используя `browse-url`)     |
| `C-u g`                 | посещение нескольких URL-адресов                            |
| `f`                     | загрузить пронумерованный URL                               |
| `C-u f`                 | загрузить несколько URL-адресов                             |
| `k`                     | сохранить пронумерованный URL-адрес в буфер                 |
| `C-u k`                 | сохранить несколько URL-адресов                             |
| `e`                     | сохранить одно или несколько вложений (запрашивается номер) |
| `<mouse-2>` на вложении | сохранить одно или несколько вложений (запрашивается номер) |
| `S-RET` на вложении     | сохранить одно или несколько вложений (запрашивается номер) |
| `C-u e`                 | выбрать вложения из списка для сохранения                   |
| `С-SPC`                 | пометить вложение в списке                                  |
| `a`                     | выполнить действие над сообщением                           |
| `A`                     | выполнить действие над MIME-частями сообщения               |


### <span class="section-num">4.6</span> Разное {#разное}

| Клавиши      | Описание                                                                  |
|--------------|---------------------------------------------------------------------------|
| `;`          | переключить контекст                                                      |
| `.`          | показать исходный вид сообщения. `q` --- отключить исходный вид сообщения |
| `C-+`, `C--` | увеличить/уменьшить количество отображаемых заголовков                    |
| `H`          | подсказка (help)                                                          |
| `C-S-u`      | обновить почту и переиндексировать                                        |
| `q`          | покунуть просмотр сообщений                                               |


## <span class="section-num">5</span> Интеграция {#интеграция}


### <span class="section-num">5.1</span> Создание сообщений {#создание-сообщений}

-   [Emacs. Почта. Message-mode]({{< relref "2021-09-27-emacs-mail-message-mode" >}})


### <span class="section-num">5.2</span> Интеграция с org-mode {#интеграция-с-org-mode}


#### <span class="section-num">5.2.1</span> Предварительная настройка {#предварительная-настройка}

-   Подключаем библиотеку для связи с _org_:
    ```elisp
    (require 'mu4e-org)
    ```
-   Следует активировать генерацию ссылок на почтовые сообщения:
    ```elisp
    (setq mu4e-support-org t)
    ```

    -   Это значение задано по умолчанию.
-   Можно захватывать ссылки для того, чтобы добавить сообщения электронной почты в свой список дел.
-   Для захвата ссылок используется функция `mu4e-org-store-and-capture`.


#### <span class="section-num">5.2.2</span> Шаблон для захвата {#шаблон-для-захвата}

-   Можно добавить специальный шаблон захвата.
-   Для шаблонов захвата доступны следующие значения для _mu4e_:

    | Шаблон                                                     | Описание                       |
    |------------------------------------------------------------|--------------------------------|
    | `%:date`, `%:date-timestamp`, `%d:date-timestamp-inactive` | дата, отметки времени          |
    | `%:from`, `%:fromname`, `%:fromaddress`                    | отправитель, имя, адрес        |
    | `%:to`, `%:toname`, `%:toaddress`                          | получатель, имя, адрес         |
    | `%:maildir`                                                | почтовый каталог для сообщения |
    | `%:message-id`                                             | идентификатор сообщения        |
    | `%:path`                                                   | путь в файловой системе        |
    | `%:subject`                                                | тема сообщения                 |
-   Примерный вид шаблона для захвата:
    ```elisp
    (add-to-list
     'org-capture-templates '("M" "TODO from mail" entry (file org-default-notes-file)
    			  "* TODO %:fromname: %:subject %?\nDEADLINE: %(org-insert-time-stamp (org-read-date nil t \"+2d\"))\n%a\n\n%i"))
    ```

    -   Сообщение добавляется в список дел и устанавливается крайний срок для его обработки в течение двух дней.
    -   Шаблон `%a` добавляет ссылку на письмо в _mu4e_.
    -   Шаблон `%i` добавляет выделенный фрагмент письма.


#### <span class="section-num">5.2.3</span> Захват сообщения {#захват-сообщения}

-   Можно задать комбинации клавиш для захвата:
    ```elisp
    (define-key mu4e-headers-mode-map (kbd "C-c c") 'mu4e-org-store-and-capture)
    (define-key mu4e-view-mode-map    (kbd "C-c c") 'mu4e-org-store-and-capture)
    ```
-   Теперь при нажатии комбинации `C-c c` при просмотре сообщения или при просмотре списка сообщений запрашивается шаблон захвата и ссылка на письмо захватывается.


#### <span class="section-num">5.2.4</span> Копирование ссылки на сообщение {#копирование-ссылки-на-сообщение}

-   В режиме просмотра сообщений (Message view) можно сохранить ссылку на конкретное сообщение: `M-x org-store-link`.
-   В режиме просмотра списка сообщений (Headers view) выполнение `M-x org-store-link`:
    -   создаёт ссылку на запрос, если `mu4e-org-link-query-in-headers-mode` не равен `nil`;
    -   создаёт ссылку на конкретное сообщение, если `mu4e-org-link-query-in-headers-mode` равен `nil` (по умолчанию).
    -   Команда обычно привязана к `C-c l`.
-   Ссылку можно вставить командой `M-x org-insert-link` (сочетание клавиш `C-c C-l`).


#### <span class="section-num">5.2.5</span> Переход на письмо {#переход-на-письмо}

-   В режиме org вы можете перейти к сообщению, на которое указывает ссылка:
    -   с помощью `M-x org-scheme-open-link` в буфере повестки дня (_agenda_);
    -   с помощью `M-x org-open-at-point` в другом месте.
-   Оба действия обычно привязаны к `C-c C-o`.


## <span class="section-num">6</span> Дополнительные пакеты {#дополнительные-пакеты}


### <span class="section-num">6.1</span> Чтение писем {#чтение-писем}


#### <span class="section-num">6.1.1</span> mu4e-views {#mu4e-views}

-   Пакет позволяет пользователю выбирать вариант просмотра электронных писем.
-   Основной вариант использования --- просмотр электронные письма с использованием окна `xwidgets`.

<!--list-separator-->

1.  Общая информация

    -   Репозиторий: <https://github.com/lordpretzel/mu4e-views>
    -   Пакет: <https://melpa.org/#/mu4e-views>


### <span class="section-num">6.2</span> Написание писем {#написание-писем}

-   [Emacs. Org-mode для написания писем]({{< relref "2022-04-27-emacs-org-mode-for-compose-emails" >}})

[^fn:1]: URL: <https://ru.wikipedia.org/wiki/Maildir>
