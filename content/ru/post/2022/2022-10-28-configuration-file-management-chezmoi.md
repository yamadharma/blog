---
title: "Управление файлами конфигурации. Домашний каталог. Chezmoi"
author: ["Dmitry S. Kulyabov"]
date: 2022-10-28T19:49:00+03:00
lastmod: 2023-07-30T14:23:00+03:00
tags: ["sysadmin"]
categories: ["computer-science"]
draft: false
slug: "configuration-file-management-chezmoi"
---

Использование `chezmoi` для управления файлами конфигурации домашнего каталога пользователя.

<!--more-->

{{< toc >}}


## <span class="section-num">1</span> Общая информация {#общая-информация}

-   Сайт: <https://www.chezmoi.io/>
-   Репозиторий: <https://github.com/twpayne/chezmoi>


## <span class="section-num">2</span> Установка {#установка}

-   Установка бинарного файла. Скрипт определяет архитектуру процессора и операционную систему и скачивает необходимый файл:
    -   с помощью `curl`:
        ```shell
        sh -c "$(curl -fsLS chezmoi.io/get)"
        ```

    -   с помощью `wget`:
        ```shell
        sh -c "$(wget -qO- chezmoi.io/get)"
        ```

    -   с помощью PowerShell:
        ```shell
        (iwr -UseBasicParsing https://chezmoi.io/get.ps1).Content | powershell -c -
        ```
-   Linux
    -   Gentoo
        -   overlay _ace_ (<https://github.com/ananace/overlay>):
            ```shell
            emerge chezmoi-bin
            ```
    -   Fedora
        -   Установка через _Snap_:
            -   Установите _Snap_:
                ```shell
                dnf install snapd
                ```
            -   Либо выйдите из системы, либо снова войдите в нее, либо перезагрузите систему, чтобы убедиться, что пути snap обновлены правильно.
            -   Включите поддержку классического варианта snap:
                ```shell
                ln -s /var/lib/snapd/snap /snap
                ```
            -   Установите chezmoi:
                ```shell
                snap install chezmoi --classic
                ```
-   Windows
    -   установка посредством Chocolatey (см. [Пакетный менеджер для Windows. Chocolatey]({{< relref "2021-01-18-package-manager-windows-chocolatey" >}})):
        ```shell
        choco install chezmoi
        ```


## <span class="section-num">3</span> Конфигурация `chezmoi` {#конфигурация-chezmoi}


### <span class="section-num">3.1</span> Рабочие файлы {#рабочие-файлы}

-   Состояние файлов конфигурации сохраняется в каталоге
    ```shell
    ~/.local/share/chezmoi
    ```
-   Он является клоном вашего репозитория `dotfiles`.
-   Файл конфигурации `~/.config/chezmoi/chezmoi.toml` (можно использовать также JSON или YAML) специфичен для локальной машины.
-   Файлы, содержимое которых одинаково на всех ваших машинах, дословно копируются из исходного каталога.
-   Файлы, которые варьируются от машины к машине, выполняются как шаблоны, обычно с использованием данных из файла конфигурации локальной машины для настройки конечного содержимого, специфичного для локальной машины.
-   При запуске
    ```shell
    chezmoi apply
    ```
    вычисляется желаемое содержимое и разрешения для каждого файла, а затем вносит необходимые изменения, чтобы ваши файлы соответствовали этому состоянию.
-   По умолчанию chezmoi изменяет файлы только в рабочей копии.


### <span class="section-num">3.2</span> Автоматически создавать файл конфигурации на новой машине {#автоматически-создавать-файл-конфигурации-на-новой-машине}

-   При выполнении `chezmoi init` также может автоматически создать файл конфигурации, если он еще не существует.
-   Если ваш репозиторий содержит файл с именем `.chezmoi.$FORMAT.tmpl`, где `$FORMAT` есть один из поддерживаемых форматов файла конфигурации (`json`, `toml`, или `yaml`), то `chezmoi init` выполнит этот шаблон для создания исходного файла конфигурации.
-   Например, пусть `~/.local/share/chezmoi/.chezmoi.toml.tmpl` выглядит так:
    ```toml
    {{- $email := promptStringOnce . "email" "Email address" -}}

    [data]
        email = {{ $email | quote }}
    ```

    -   При выполнении `chezmoi init` будет создан конфигурационный файл `~/.config/chezmoi/chezmoi.toml`.
    -   `promptStringOnce` --- это специальная функция, которая запрашивает у пользователя значение, если оно еще не установлено в разделе `data` конфигурационного файла.
-   Чтобы протестировать этот шаблон, используйте `chezmoi execute-template` с флагами `--init` и `--promptString`, например:
    ```shell
    chezmoi execute-template --init --promptString email=me@home.org < ~/.local/share/chezmoi/.chezmoi.toml.tmpl
    ```


### <span class="section-num">3.3</span> Пересоздание файл конфигурации {#пересоздание-файл-конфигурации}

-   Если вы измените шаблон файла конфигурации, `chezmoi` предупредит вас, если ваш текущий файл конфигурации не был сгенерирован из этого шаблона.
-   Вы можете повторно сгенерировать файл конфигурации, запустив:
    ```shell
    chezmoi init
    ```


## <span class="section-num">4</span> Шаблоны {#шаблоны}


### <span class="section-num">4.1</span> Общая информация {#общая-информация}

-   Шаблоны используются для изменения содержимого файла в зависимости от среды.
-   Используется синтаксис шаблонов Go.
-   Файл интерпретируется как шаблон, если выполняется одно из следующих условий:
    -   имя файла имеет суффикс `.tmpl`;
    -   файл находится в каталоге `.chezmoitemplates`.


### <span class="section-num">4.2</span> Данные шаблона {#данные-шаблона}

-   Полный список переменных шаблона:
    ```shell
    chezmoi data
    ```
-   Источники переменных:
    -   файлы `.chezmoi`, например, `.chezmoi.os`;
    -   файлы конфигурации `.chezmoidata.$FORMAT`. Форматы (`json`, `jsonc`, `toml`, `yaml`) читаются в алфавитном порядке;
    -   раздел `data` конфигурационного файла.


### <span class="section-num">4.3</span> Способы создания файла шаблона {#способы-создания-файла-шаблона}

-   При первом добавлении файла передайте аргумент `--template`:
    ```shell
    chezmoi add --template ~/.zshrc
    ```
-   Если файл уже контролируется _chezmoi_, но не является шаблоном, можно сделать его шаблоном:
    ```shell
    chezmoi chattr +template ~/.zshrc
    ```
-   Можно создать шаблон вручную в исходном каталоге, присвоив ему расширение `.tmpl`:
    ```shell
    chezmoi cd
    $EDITOR dot_zshrc.tmpl
    ```
-   Шаблоны в каталоге `.chezmoitemplates` должны создаваться вручную:
    ```shell
    chezmoi cd
    mkdir -p .chezmoitemplates
    cd .chezmoitemplates
    $EDITOR mytemplate
    ```


### <span class="section-num">4.4</span> Редактирование файла шаблона {#редактирование-файла-шаблона}

-   Используйте `chezmoi edit`:
    ```shell
    chezmoi edit ~/.zshrc
    ```
-   Чтобы сделанные вами изменения сразу же применялись после выхода из редактора, используйте опцию `--apply`:
    ```shell
    chezmoi edit --apply ~/.zshrc
    ```


### <span class="section-num">4.5</span> Тестирование шаблонов {#тестирование-шаблонов}

-   Тестирование с помощью команды `chezmoi execute-template`.
-   Тестирование небольших фрагментов шаблонов:
    ```shell
    chezmoi execute-template '{{ .chezmoi.hostname }}'
    ```
-   Тестирование целых файлов:
    ```shell
    chezmoi cd
    chezmoi execute-template < dot_zshrc.tmpl
    ```


### <span class="section-num">4.6</span> Синтаксис шаблона {#синтаксис-шаблона}

-   Действия шаблона записываются внутри двойных фигурных скобок, `{{ }}`.
-   Действия могут быть переменными, конвейерами или операторами управления.
-   Текст вне действий копируется буквально.
-   Переменные записываются буквально:

<!--listend-->

```web
{{ .chezmoi.hostname }}
```

-   Условные выражения могут быть записаны с использованием `if`, `else if`, `else`, `end`:

<!--listend-->

```web
{{ if eq .chezmoi.os "darwin" }}
# darwin
{{ else if eq .chezmoi.os "linux" }}
# linux
{{ else }}
# other operating system
{{ end }}
```


#### <span class="section-num">4.6.1</span> Удаление пробелов {#удаление-пробелов}

-   Для удаления проблем в шаблоне разместите знак минус и пробела рядом со скобками:
    ```web
    HOSTNAME={{- .chezmoi.hostname }}
    ```
-   В результате получим:
    ```shell
    HOSTNAME=myhostname
    ```


#### <span class="section-num">4.6.2</span> Отладка шаблона {#отладка-шаблона}

-   Используется подкоманда `execute-template`:
    ```shell
    chezmoi execute-template '{{ .chezmoi.os }}/{{ .chezmoi.arch }}'
    ```
-   Интерпретируются любые данные, поступающие со стандартного ввода или в конце команды.
-   Можно передать содержимое файла этой команде:
    ```shell
    cat foo.txt | chezmoi execute-template
    ```


#### <span class="section-num">4.6.3</span> Логические операции {#логические-операции}

-   Возможно выполнение логических операций.
-   Если имя хоста машины равно `work-laptop`, текст между `if` и `end` будет включён в результат:
    ```web
    # common config
    export EDITOR=vi

    # machine-specific configuration
    {{- if eq .chezmoi.hostname "work-laptop" }}
    # this will only be included in ~/.bashrc on work-laptop
    {{- end }}
    ```

<!--list-separator-->

1.  Логические функции

    -   `eq`: возвращает `true`, если первый аргумент равен любому из остальных аргументов, может принимать несколько аргументов;
    -   `not`: возвращает логическое отрицание своего единственного аргумента;
    -   `and`: возвращает логическое И своих аргументов, может принимать несколько аргументов;
    -   `or`: возвращает логическое ИЛИ своих аргументов, может принимать несколько аргументов.

<!--list-separator-->

2.  Целочисленные функции

    -   `len`: возвращает целочисленную длину своего аргумента;
    -   `eq`: возвращает логическую истину `arg1 == arg2`;
    -   `ne`: возвращает логическое значение `arg1 != arg2`;
    -   `lt`: возвращает логическую истину `arg1 < arg2`;
    -   `le`: возвращает логическую истину `arg1 <= arg2`;
    -   `gt`: возвращает логическую истину `arg1 > arg2`;
    -   `ge`: возвращает логическую истину `arg1 >= arg2`.


### <span class="section-num">4.7</span> Переменные шаблона {#переменные-шаблона}

-   Чтобы просмотреть переменные, доступные в вашей системе, выполните:
    ```shell
    chezmoi data
    ```
-   Чтобы получить доступ к переменной `chezmoi.kernel.osrelease` в шаблоне, используйте:
    ```web
    {{ .chezmoi.kernel.osrelease }}
    ```


## <span class="section-num">5</span> Использование `chezmoi` {#использование-chezmoi}


### <span class="section-num">5.1</span> Первоначальная настройка на первичном хосте {#первоначальная-настройка-на-первичном-хосте}

-   Инициализируйте `chezmoi` командой:
    ```shell
    chezmoi init
    ```
-   Это создаст новый локальный репозиторий git в `~/.local/share/chezmoi`.
-   Добавьте в репозиторий первый файл с помощью `chezmoi`:
    ```shell
    chezmoi add ~/.bashrc
    ```
-   Команда скопирует `~/.bashrc` в `~/.local/share/chezmoi/dot_bashrc`.
-   Можно отредактировать файл:
    ```shell
    chezmoi edit ~/.bashrc
    ```
-   Откроется `~/.local/share/chezmoi/dot_bashrc` в редакторе, заданном переменной `$EDITOR`.
-   Внесите некоторые изменения и сохраните файл.
-   Посмотрите, какие изменения внес бы `chezmoi`:
    ```shell
    chezmoi diff
    ```
-   Примените изменения:
    ```shell
    chezmoi -v apply
    ```
-   Все команды `chezmoi` принимают  флаг `-v` (подробная информация) и флаг `-n` (пробный запуск, демонстрирующий, но не вносящий изменения).


### <span class="section-num">5.2</span> Репозиторий на github {#репозиторий-на-github}

-   Создайте репозиторий `dotfiles` для хранения конфигурационных файлов.
-   Для определённости будем использовать <https://github.com>.
-   Поддерживается хранение ваших конфигурационных файлов как в общедоступных, так и в частных репозиториях.
-   Создать репозиторий можно вручную или из командной строки (см. [github: утилиты командной строки]({{< relref "2021-08-04-github-command-line-utilities" >}})):
    ```shell
    gh repo create dotfiles --private
    ```
-   Откройте оболочку в исходном каталоге, чтобы зафиксировать изменения:
    ```shell
    chezmoi cd
    git add .
    git commit -m "Initial commit"
    ```
-   Подключите репозиторий и выгрузите файлы:
    ```shell
    git remote add origin git@github.com:username/dotfiles.git
    git push --set-upstream origin master
    git push -u origin
    ```
-   Выйдите из оболочки `chezmoi`:
    ```shell
    exit
    ```


### <span class="section-num">5.3</span> Использование chezmoi на нескольких машинах {#использование-chezmoi-на-нескольких-машинах}

-   На второй машине инициализируйте `chezmoi` с вашим репозиторием `dotfiles`:
    ```shell
    chezmoi init https://github.com/username/dotfiles.git
    ```
-   Проверьте, какие изменения внесёт `chezmoi` в домашний каталог, запустив:
    ```shell
    chezmoi diff
    ```
-   Если вас устраивают изменения, внесённые `chezmoi`, запустите:
    ```shell
    chezmoi apply -v
    ```
-   Если вас не устраивают изменения в файле, отредактируйте его с помощью:
    ```shell
    chezmoi edit file_name
    ```
-   Также можно вызвать инструмент слияния, чтобы объединить изменения между текущим содержимым файла, файлом в вашей рабочей копии и измененным содержимым файла:
    ```shell
    chezmoi merge file_name
    ```
-   При существующем каталоге `chezmoi` можно получить и применить последние изменения из вашего репозитория:
    ```shell
    chezmoi update -v
    ```


### <span class="section-num">5.4</span> Настройка новой машины с помощью одной команды {#настройка-новой-машины-с-помощью-одной-команды}

-   Можно установить свои `dotfiles` на новый компьютер с помощью одной команды:
    ```shell
    chezmoi init --apply https://github.com/username/dotfiles.git
    ```


### <span class="section-num">5.5</span> Ежедневные операции c `chezmoi` {#ежедневные-операции-c-chezmoi}


#### <span class="section-num">5.5.1</span> Извлеките последние изменения из репозитория и примените их {#извлеките-последние-изменения-из-репозитория-и-примените-их}

-   Можно извлечь изменения из репозитория и применить их одной командой:
    ```shell
    chezmoi update
    ```
-   Это запускается `git pull --autostash --rebase` в вашем исходном каталоге, а затем `chezmoi apply`.


#### <span class="section-num">5.5.2</span> Извлеките последние изменения из своего репозитория и посмотрите, что изменится, фактически не применяя изменения {#извлеките-последние-изменения-из-своего-репозитория-и-посмотрите-что-изменится-фактически-не-применяя-изменения}

-   Выполните:
    ```shell
    chezmoi git pull -- --autostash --rebase && chezmoi diff
    ```
-   Это запускается `git pull --autostash --rebase` в вашем исходном каталоге, а `chezmoi diff` затем показывает разницу между целевым состоянием, вычисленным из вашего исходного каталога, и фактическим состоянием.
-   Если вы довольны изменениями, вы можете применить их:
    ```shell
    chezmoi apply
    ```


#### <span class="section-num">5.5.3</span> Автоматически фиксируйте и отправляйте изменения в репозиторий {#автоматически-фиксируйте-и-отправляйте-изменения-в-репозиторий}

-   Можно автоматически фиксировать и отправлять изменения в исходный каталог в репозиторий.
-   Эта функция отключена по умолчанию.
-   Чтобы включить её, добавьте в файл конфигурации `~/.config/chezmoi/chezmoi.toml` следующее:
    ```shell
    [git]
        autoCommit = true
        autoPush = true
    ```
-   Всякий раз, когда в исходный каталог вносятся изменения, `chezmoi` фиксирует изменения с помощью автоматически сгенерированного сообщения фиксации и отправляет их в ваш репозиторий.
-   Будьте осторожны при использовании `autoPush`. Если ваш репозиторий `dotfiles` является общедоступным, и вы случайно добавили секрет в виде обычного текста, этот секрет будет отправлен в ваш общедоступный репозиторий.
