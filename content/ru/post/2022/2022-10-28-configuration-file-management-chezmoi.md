---
title: "Управление файлами конфигурации. Chezmoi"
author: ["Dmitry S. Kulyabov"]
date: 2022-10-28T19:49:00+03:00
lastmod: 2023-01-15T20:32:00+03:00
tags: ["sysadmin"]
categories: ["computer-science"]
draft: false
slug: "configuration-file-management-chezmoi"
---

Использование `chezmoi` для управления файлами конфигурации домашнего каталога пользователя.

<!--more-->

{{< toc >}}


## <span class="section-num">1</span> Общая информация {#общая-информация}

-   Сайт: <https://www.chezmoi.io/>
-   Репозиторий: <https://github.com/twpayne/chezmoi>


## <span class="section-num">2</span> Установка {#установка}

-   Установка бинарного файла. Скрипт определяет архитектуру процессора и операционную систему и скачивает необходимый файл:
    -   с помощью `curl`:
        ```shell
        sh -c "$(curl -fsLS chezmoi.io/get)"
        ```

    -   с помощью `wget`:
        ```shell
        sh -c "$(wget -qO- chezmoi.io/get)"
        ```

    -   с помощью PowerShell:
        ```shell
        (iwr -UseBasicParsing https://chezmoi.io/get.ps1).Content | powershell -c -
        ```
-   Linux
    -   Gentoo
        -   overlay _ace_ (<https://github.com/ananace/overlay>):
            ```shell
            emerge chezmoi-bin
            ```
    -   Fedora
        -   установка через Snap:
            ```shell
            snap install chezmoi --classic
            ```
-   Windows
    -   установка посредством Chocolatey (см. [Пакетный менеджер для Windows. Chocolatey]({{< relref "2021-01-18-package-manager-windows-chocolatey" >}})):
        ```shell
        choco install chezmoi
        ```


## <span class="section-num">3</span> Конфигурация `chezmoi` {#конфигурация-chezmoi}


### <span class="section-num">3.1</span> Рабочие файлы {#рабочие-файлы}

-   Состояние файлов конфигурации сохраняется в каталоге
    ```shell
    ~/.local/share/chezmoi
    ```
-   Он является клоном вашего репозитория `dotfiles`.
-   Файл конфигурации `~/.config/chezmoi/chezmoi.toml` (можно использовать также JSON или YAML) специфичен для локальной машины.
-   Файлы, содержимое которых одинаково на всех ваших машинах, дословно копируются из исходного каталога.
-   Файлы, которые варьируются от машины к машине, выполняются как шаблоны, обычно с использованием данных из файла конфигурации локальной машины для настройки конечного содержимого, специфичного для локальной машины.
-   При запуске
    ```shell
    chezmoi apply
    ```
    вычисляется желаемое содержимое и разрешения для каждого файла, а затем вносит необходимые изменения, чтобы ваши файлы соответствовали этому состоянию.
-   По умолчанию chezmoi изменяет файлы только в рабочей копии.


### <span class="section-num">3.2</span> Автоматически создавать файл конфигурации на новой машине {#автоматически-создавать-файл-конфигурации-на-новой-машине}

-   При выполнении `chezmoi init` также может автоматически создать файл конфигурации, если он еще не существует.
-   Если ваш репозиторий содержит файл с именем `.chezmoi.$FORMAT.tmpl`, где `$FORMAT` есть один из поддерживаемых форматов файла конфигурации (`json`, `toml`, или `yaml`), то `chezmoi init` выполнит этот шаблон для создания исходного файла конфигурации.
-   Например, пусть `~/.local/share/chezmoi/.chezmoi.toml.tmpl` выглядит так:
    ```toml
    {{- $email := promptStringOnce . "email" "Email address" -}}

    [data]
        email = {{ $email | quote }}
    ```

    -   При выполнении `chezmoi init` будет создан конфигурационный файл `~/.config/chezmoi/chezmoi.toml`.
    -   `promptStringOnce` --- это специальная функция, которая запрашивает у пользователя значение, если оно еще не установлено в разделе `data` конфигурационного файла.
-   Чтобы протестировать этот шаблон, используйте `chezmoi execute-template` с флагами `--init` и `--promptString`, например:
    ```shell
    chezmoi execute-template --init --promptString email=me@home.org < ~/.local/share/chezmoi/.chezmoi.toml.tmpl
    ```


### <span class="section-num">3.3</span> Пересоздание файл конфигурации {#пересоздание-файл-конфигурации}

-   Если вы измените шаблон файла конфигурации, `chezmoi` предупредит вас, если ваш текущий файл конфигурации не был сгенерирован из этого шаблона.
-   Вы можете повторно сгенерировать файл конфигурации, запустив:
    ```shell
    chezmoi init
    ```


## <span class="section-num">4</span> Использование `chezmoi` {#использование-chezmoi}


### <span class="section-num">4.1</span> Первоначальная настройка на первичном хосте {#первоначальная-настройка-на-первичном-хосте}

-   Инициализируйте `chezmoi` командой:
    ```shell
    chezmoi init
    ```
-   Это создаст новый локальный репозиторий git в `~/.local/share/chezmoi`.
-   Добавьте в репозиторий первый файл с помощью `chezmoi`:
    ```shell
    chezmoi add ~/.bashrc
    ```
-   Команда скопирует `~/.bashrc` в `~/.local/share/chezmoi/dot_bashrc`.
-   Можно отредактировать файл:
    ```shell
    chezmoi edit ~/.bashrc
    ```
-   Откроется `~/.local/share/chezmoi/dot_bashrc` в редакторе, заданном переменной `$EDITOR`.
-   Внесите некоторые изменения и сохраните файл.
-   Посмотрите, какие изменения внес бы `chezmoi`:
    ```shell
    chezmoi diff
    ```
-   Примените изменения:
    ```shell
    chezmoi -v apply
    ```
-   Все команды `chezmoi` принимают  флаг `-v` (подробная информация) и флаг `-n` (пробный запуск, демонстрирующий, но не вносящий изменения).
-   Создайте репозиторий `dotfiles` для хранения конфигурационных файлов.
-   Поддерживается хранение ваших конфигурационных файлов как в общедоступных, так и в частных репозиториях.
-   Создать репозиторий можно вручную или из командной строки:
    ```shell
    gh repo create dotfiles
    ```
-   Откройте оболочку в исходном каталоге, чтобы зафиксировать изменения:
    ```shell
    chezmoi cd
    git add .
    git commit -m "Initial commit"
    ```
-   Подключите репозиторий и выгрузите файлы:
    ```shell
    git remote add origin git@github.com:username/dotfiles.git
    git push -u origin
    ```
-   Выйдите из оболочки `chezmoi`:
    ```shell
    exit
    ```


### <span class="section-num">4.2</span> Использование chezmoi на нескольких машинах {#использование-chezmoi-на-нескольких-машинах}

-   На второй машине инициализируйте `chezmoi` с вашим репозиторием `dotfiles`:
    ```shell
    chezmoi init https://github.com/username/dotfiles.git
    ```
-   Проверьте, какие изменения внесёт `chezmoi` в домашний каталог, запустив:
    ```shell
    chezmoi diff
    ```
-   Если вас устраивают изменения, внесённые `chezmoi`, запустите:
    ```shell
    chezmoi apply -v
    ```
-   Если вас не устраивают изменения в файле, отредактируйте его с помощью:
    ```shell
    chezmoi edit file_name
    ```
-   Также можно вызвать инструмент слияния, чтобы объединить изменения между текущим содержимым файла, файлом в вашей рабочей копии и измененным содержимым файла:
    ```shell
    chezmoi merge file_name
    ```
-   При существующем каталоге `chezmoi` можно получить и применить последние изменения из вашего репозитория:
    ```shell
    chezmoi update -v
    ```


### <span class="section-num">4.3</span> Настройка новой машины с помощью одной команды {#настройка-новой-машины-с-помощью-одной-команды}

-   Можно установить свои `dotfiles` на новый компьютер с помощью одной команды:
    ```shell
    chezmoi init --apply https://github.com/username/dotfiles.git
    ```


### <span class="section-num">4.4</span> Ежедневные операции c `chezmoi` {#ежедневные-операции-c-chezmoi}


#### <span class="section-num">4.4.1</span> Извлеките последние изменения из репозитория и примените их. {#извлеките-последние-изменения-из-репозитория-и-примените-их-dot}

-   Можно извлечь изменения из репозитория и применить их одной командой:
    ```shell
    chezmoi update
    ```
-   Это запускается `git pull --autostash --rebase` в вашем исходном каталоге, а затем `chezmoi apply`.


#### <span class="section-num">4.4.2</span> Извлеките последние изменения из своего репозитория и посмотрите, что изменится, фактически не применяя изменения {#извлеките-последние-изменения-из-своего-репозитория-и-посмотрите-что-изменится-фактически-не-применяя-изменения}

-   Выполните:
    ```shell
    chezmoi git pull -- --autostash --rebase && chezmoi diff
    ```
-   Это запускается `git pull --autostash --rebase` в вашем исходном каталоге, а `chezmoi diff` затем показывает разницу между целевым состоянием, вычисленным из вашего исходного каталога, и фактическим состоянием.
-   Если вы довольны изменениями, вы можете применить их:
    ```shell
    chezmoi apply
    ```


#### <span class="section-num">4.4.3</span> Автоматически фиксируйте и отправляйте изменения в репозиторий {#автоматически-фиксируйте-и-отправляйте-изменения-в-репозиторий}

-   Можно автоматически фиксировать и отправлять изменения в исходный каталог в репозиторий.
-   Эта функция отключена по умолчанию.
-   Чтобы включить её, добавьте в файл конфигурации `~/.config/chezmoi/chezmoi.toml` следующее:
    ```shell
    [git]
        autoCommit = true
        autoPush = true
    ```
-   Всякий раз, когда в исходный каталог вносятся изменения, `chezmoi` фиксирует изменения с помощью автоматически сгенерированного сообщения фиксации и отправляет их в ваш репозиторий.
-   Будьте осторожны при использовании `autoPush`. Если ваш репозиторий `dotfiles` является общедоступным, и вы случайно добавили секрет в виде обычного текста, этот секрет будет отправлен в ваш общедоступный репозиторий.
