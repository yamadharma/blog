---
title: "Emacs. Org Babel"
author: ["Dmitry S. Kulyabov"]
date: 2022-10-15T21:21:00+03:00
lastmod: 2023-07-06T15:02:00+03:00
tags: ["emacs", "org-mode"]
categories: ["computer-science"]
draft: false
slug: "emacs-org-babel"
---

Org Babel.

<!--more-->

{{< toc >}}


## <span class="section-num">1</span> Общая информация {#общая-информация}

-   _Org Babel_ используется для работы с исходным кодом разных языков программирования внутри _org-mode_.
-   Исходный код задаётся в блоке `#+BEGIN_SRC...#+END_SRC`.
-   Для редактирования и форматирования блока исходного кода используется соответствующий основной режим Emacs, включающий функции, специально разработанные для исходного кода на этом языке.
-   Для выполнения компиляции блока исходного кода можно использовать соответствующий компилятор.
-   Важной особенностью управления блоками исходного кода в _org-mode_ является возможность передавать переменные, функции и результаты друг другу, используя общий синтаксис для блоков исходного кода на любом языке.


## <span class="section-num">2</span> Структура блока кода {#структура-блока-кода}

-   Исходный код может быть в блоке исходного кода и непосредственно в строке.
-   Блок исходного кода:
    ```org
    #+NAME: <name>
    #+BEGIN_SRC <language> <switches> <header arguments>
      <body>
    #+END_SRC
    ```
-   Блок встроенного кода:
    ```org
    src_<language>[<header arguments>]{<body>}
    ```
-   Основные элементы:
    -   `#+NAME: <name>` : опциональное название блока исходного кода.
    -   `#+BEGIN_SRC … #+END_SRC` : обязательные ограничители блока.
    -   `<language>` : обязательный идентификатор языка исходного кода в блоке.
    -   `<switches>` : опциональная настройка кодового блока.
    -   `<header arguments>` : опциональные аргументы заголовка. Управляют многими аспектами выполнения и экспорта блоков кода.
    -   `<body>` : исходный код.


## <span class="section-num">3</span> Исполнение кода блоков {#исполнение-кода-блоков}


### <span class="section-num">3.1</span> Исполнение исходного кода {#исполнение-исходного-кода}

-   Org захватывает результаты выполнения блока кода и вставляет их в файл Org сразу после блока кода.
-   Точка вставки находится после новой строки и ключевого слова `RESULTS` (оно создаётся, если его не было).
-   По умолчанию Org разрешает выполнение только блоков кода Emacs Lisp.
-   Выполнение блоков кода: `C-c C-c` или `C-c C-v e` на кодовом блоке вызывает функцию `org-babel-execute-src-block`, которая выполняет код в блоке, собирает результаты и вставляет их в буфер.
-   Содержимое блока кода может быть исполнено из другого места файла.
-   Вызов можно выполнить с помощью ключевого слова:
    ```org
    #+CALL: <name>(<arguments>)
    #+CALL: <name>[<inside header arguments>](<arguments>) <end header arguments>
    ```
-   Можно использовать встроенные вызовы:
    ```org
    ... call_<name>(<arguments>) ...
    ... call_<name>[<inside header arguments>](<arguments>)[<end header arguments>] ...
    ```

    -   В этом случае результат представляется на основе переменной `org-babel-inline-result-wrap`, для которой по умолчанию задано значение `=%s=` для получения дословного текста.
-   Параметры вызова:
    -   `<name>` : имя блока кода. Если блок находится в другом файле, имя предваряется именем файла, за которым следует двоеточие.
    -   `<arguments>` : аргументы, передаваемые в блок кода.
    -   `<inside header arguments>` : внутренние аргументы заголовка в именованном блоке кода.
    -   `<end header arguments>` : влияют на результаты, возвращаемые блоком кода.


### <span class="section-num">3.2</span> Ограничение на исполнение кода {#ограничение-на-исполнение-кода}

-   Аргумент заголовка `eval` может ограничивать выполнение определённых блоков кода (в основном для обеспечения безопасности):
    -   `never` или `no` : никогда не исполнять код;
    -   `query` : запрашивает у пользователя разрешение на исполнение исходного кода;
    -   `never-export` или `no-export` : не исполнять исходный код при экспорте;
    -   `query-export` : запрашивает у пользователя разрешение на исполнение исходного кода во время экспорта.
-   Запрос на выполнение управляется переменной `org-confirm-babel-evaluate`.
-   Чтобы отключить запрос на выполнение, следует установить:
    ```emacs-lisp
    (setq org-confirm-babel-evaluate nil)
    ```


## <span class="section-num">4</span> Экспорт блоков кода {#экспорт-блоков-кода}

-   Можно экспортировать код из блоков babel, результаты выполнения блока кода.
-   Аргумент заголовка `:exports` должен указывать, экспортируется ли эта часть файла:
    -   `code` (`:exports code`) : Обычно является значением по умолчанию. Код включается в экспортируемый файл.
    -   `results` (`:exports results`) : Результаты выполнения кода включаются в экспортируемый файл.
    -   `both` (`:exports both`) : И код, и результаты выполнения включаются в экспортируемый файл.
    -   `none` (`:exports none`) : Ни код, ни результаты выполнения не включаются в экспортируемый файл.
-   Чтобы не выполнять блоки кода для ускорения экспорта, используется аргумент заголовка `:eval never-export`.
-   Для отключения исполнения кода глобально следует установить переменную `org-export-use-babel` в значение `nil`.


## <span class="section-num">5</span> Экспорт рисунков `svg` {#экспорт-рисунков-svg}

-   При экспорте результатов вычисления, являющимися фигурами в формате `svg`, можно внедрить код в текст.
-   Для этого нужно добавить к результату атрибут:
    ```org
    #+attr_html: :inlined t
    ```
