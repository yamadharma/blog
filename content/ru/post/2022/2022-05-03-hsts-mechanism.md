---
title: "Механизм HSTS"
author: ["Dmitry S. Kulyabov"]
date: 2022-05-03T20:05:00+03:00
lastmod: 2023-09-19T10:56:00+03:00
tags: ["security", "network"]
categories: ["computer-science"]
draft: false
slug: "hsts-mechanism"
---

_HSTS_ (_HTTP Strict Transport Security_) --- механизм, принудительно активирующий защищённое соединение через протокол HTTPS.

<!--more-->

{{< toc >}}


## <span class="section-num">1</span> Общая информация {#общая-информация}

-   HSTS защищает от даунгрейд-атак на TLS.
-   Указывает броузеру всегда использовать TLS для сайтов с соответствующими политиками.
-   Стандарт описан в RFC 6797.


## <span class="section-num">2</span> Механизм работы {#механизм-работы}

-   Сервер сообщает о политиках HSTS с помощью специального заголовка при подключении по протоколу _https_.
-   При подключении по /http заголовок HSTS игнорируется.
-   Когда сайт применяет политику HSTS, пользовательские броузеры, корректно воспринимающие заголовок HSTS, должны:
    -   Автоматически автономно преобразовывать все http-ссылки на данный сайт в https-ссылки.
    -   Если безопасность соединения https не может быть проверена (в частности, если TLS-сертификат сервера не подписан доверенным ключом), будет показано сообщение об ошибке, и пользователь будет лишен доступа к сайту.


## <span class="section-num">3</span> Типы политик {#типы-политик}


### <span class="section-num">3.1</span> Динамические политики {#динамические-политики}

-   Политика применяется из HTTP-заголовка _Strict-Transport-Security_ при первом заходе на сайт по HTTPS.
-   В заголовке указан срок действия и применимость к субдоменам.


### <span class="section-num">3.2</span> Статические политики {#статические-политики}

-   Исходный вариант HSTS не защищает первое подключение пользователя к сайту. Злоумышленник может легко перехватить первое подключение, если оно происходит по протоколу http.
-   Для борьбы с этой проблемой большинство современных броузеров использует дополнительный статический список сайтов (_HSTS preload list_), требующих использования протокола https.
-   Список составляется авторами Google Chrome с 2010 года.
-   На базе этого списка составляются подобные списки для других броузеров.


## <span class="section-num">4</span> Проверка работы {#проверка-работы}

-   Можно проверить с помощью сайта: <https://www.ssllabs.com/ssltest/index.html>.


## <span class="section-num">5</span> Поддержка на стороне сервера {#поддержка-на-стороне-сервера}


### <span class="section-num">5.1</span> Apache {#apache}


#### <span class="section-num">5.1.1</span> Включение HSTS {#включение-hsts}

-   За HSTS отвечает директива `Strict-Transport-Security`.
-   Реализуется с помощью модуля `mod_headers`.
-   Для блока `<VirtualHost *:443>` следует установить
    ```conf-unix
    <VirtualHost *:443>
    ...
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
    ...
    </VirtualHost>
    ```

    -   `max-age`: время, в течение которого броузер должен применять заголовок HSTS для этого сайта. Указан 1 год.
    -   `includeSubDomains`: применять HSTS также для субдоменов.


## <span class="section-num">6</span> Поддержка на стороне клиента {#поддержка-на-стороне-клиента}


### <span class="section-num">6.1</span> Chrome {#chrome}


#### <span class="section-num">6.1.1</span> Отключение HSTS {#отключение-hsts}

-   Настройки находятся по адресу `chrome://net-internals/#hsts`.
-   В _Query HSTS/PKP domain_ укажем наш домен и нажмём _Query_ для информации по настройке сайта.
-   В разделе _Delete domain security policies_ указываем наш домен, нажимаем _Delete_.
-   Перезапускаем броузер.
