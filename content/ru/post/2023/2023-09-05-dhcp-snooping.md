---
title: "DHCP snooping"
author: ["Dmitry S. Kulyabov"]
date: 2023-09-05T09:49:00+03:00
lastmod: 2023-09-05T12:49:00+03:00
tags: ["sysadmin"]
categories: ["computer-science"]
draft: false
slug: "dhcp-snooping"
---

_DHCP snooping_.

<!--more-->

{{< toc >}}


## <span class="section-num">1</span> Общая информация {#общая-информация}

-   _DHCP snooping_ --- функция коммутатора, предназначенная для защиты от атак с использованием протокола DHCP.
-   Например, атаки с подменой DHCP-сервера в сети или атаки DHCP starvation, которая заставляет DHCP-сервер выдать все существующие на сервере адреса злоумышленнику.
-   _DHCP snooping_ позволяет:
    -   защитить клиентов в сети от получения адреса от неавторизованного DHCP-сервера;
    -   регулировать какие сообщения протокола DHCP отбрасывать, какие перенаправлять и на какие порты.
-   Для правильной работы _DHCP snooping_, необходимо указать какие порты коммутатора будут доверенными (trusted), а какие --- ненадёжными (untrusted).
-   Ненадёжные (Untrusted) порты: порты, к которым подключены клиенты.
    -   DHCP-ответы, приходящие с этих портов отбрасываются коммутатором.
    -   Для ненадёжных портов выполняется ряд проверок сообщений DHCP и создаётся база данных привязки DHCP (_DHCP snooping_ binding database).
-   Доверенные (Trusted) порты: порты коммутатора, к которым подключён другой коммутатор или DHCP-сервер.
    -   DHCP-пакеты полученные с доверенных портов не отбрасываются.


## <span class="section-num">2</span> Принципы работы _DHCP snooping_ {#принципы-работы-dhcp-snooping}

-   По умолчанию коммутатор отбрасывает DHCP-пакет, который пришел на ненадёжный порт, если:
    -   приходит одно из сообщений, которые отправляет DHCP-сервер (DHCPOFFER, DHCPACK, DHCPNAK или DHCPLEASEQUERY);
    -   приходит сообщение DHCPRELEASE или DHCPDECLINE, в котором содержится MAC-адрес из базы данных привязки DHCP, но информация об интерфейсе в таблице не совпадает с интерфейсом, на котором был получен пакет;
    -   в пришедшем DHCP-пакете не совпадают MAC-адрес указанный в DHCP-запросе и MAC-адрес отправителя;
    -   приходит DHCP-пакет, в котором есть опция 82.


## <span class="section-num">3</span> Опция 82 {#опция-82}

-   По умолчанию коммутатор на котором включен _DHCP snooping_, вставляет опцию 82 в DHCP-запросы.
-   Коммутатор может изменять или вставлять опцию 82, даже если клиент и сервер находятся в одной подсети.
-   При вставке опции 82, коммутатор вставляет два значения:
    -   Remote ID (MAC-адрес или IP-адрес коммутатора) (это значение можно настраивать);
    -   Circuit ID (порт с которого пришел запрос) (это значение не настраивается).
-   По умолчанию коммутатор, использующий _DHCP snooping_, обнаруживает и отбрасывает любой DHCP-запрос содержащий опцию 82, который он получил через ненадёжный порт.
-   Этот режим стоит оставить, если коммутатор соединен с конечными клиентами. Получение запроса с опцией 82 от клиента будет говорит об атаке, которую коммутатор должен предотвратить.
-   Но если функция _DHCP snooping_ включена на нескольких коммутаторах, которые соединены последовательно, то такое поведение по умолчанию, приведет к тому, что клиенты не смогут получить адрес по DHCP (если сервер находится через несколько коммутаторов).
-   Решения этой проблемы:
    -   Сделать порт, к которому подсоединён нижележащий коммутатор, доверенным.
    -   Настроить варианты обработки опции 82 на вышележащем коммутаторе:
        -   сохранить опцию 82 в пришедшем пакете;
        -   заменить опцию 82 в пришедшем пакете.
    -   Отключить вставку опции 82 на коммутаторе.


## <span class="section-num">4</span> DHCP-ретранслятор {#dhcp-ретранслятор}

-   Настройки опции 82 с _DHCP snooping_ перекрывают любые глобальные настройки указанные при настройке коммутатора для работы DHCP-ретранслятором.
-   Если _DHCP snooping_ не настроен в VLAN, то для него применяются глобальные настройки.


## <span class="section-num">5</span> Настройка {#настройка}


### <span class="section-num">5.1</span> Порядок настройки {#порядок-настройки}

-   Настройка и проверка работы DHCP-сервера и DHCP-ретранслятора без включенного _DHCP snooping_.
-   Включение _DHCP snooping_. После включения _DHCP snooping_ на коммутаторе и в соответствующих VLAN, все порты коммутатора по умолчанию считаются ненадёжными.
-   Указание доверенных портов. Те порты к которым подключены коммутаторы и которые ведут к DHCP-серверу (или порты к которым сервер подключен) должны быть настроены как доверенные.
-   Настройка политики обработки опции 82.
-   (Опционально) Включение или выключение дополнительных проверок DHCP-сообщений.
-   После того, как _DHCP snooping_ включен на коммутаторе, по мере выдачи адресов клиентам, начинает заполняться база данных привязки DHCP.
-   В базе данных привязки DHCP хранятся (информация хранится только о ненадёжных портах):
    -   MAC-адрес клиента
    -   Арендованный IP-адрес клиента
    -   Время аренды в секундах
    -   Идентификатор VLAN
    -   Идентификатор порта к которому присоединен клиент


### <span class="section-num">5.2</span> Коммутаторы Cisco {#коммутаторы-cisco}


#### <span class="section-num">5.2.1</span> Основные настройки {#основные-настройки}

-   Включаем глобально DHCP snoopig на коммутаторе:
    ```shell
    switch(config)#ip dhcp snooping
    ```

-   Включаем _DHCP snooping_ в нужном VLAN:
    ```shell
    switch(config)#ip dhcp snooping vlan 100
    ```

-   Указываем доверенные порты:
    ```shell
    switch(config)#interface GigabitEthernet 1/0/1
    switch(config-if)#ip dhcp snooping trust
    ```


#### <span class="section-num">5.2.2</span> Дополнительные настройки {#дополнительные-настройки}

-   Можно отключить передачу опции 82:
    ```shell
    switch(config)#no ip dhcp snooping information option
    ```
-   Можно настроить ограничение количества DHCP обращений на не доверенном интерфейсе:
    ```shell
    switch(config)#interface gigabitEthernet 1/0/1
    switch(config-if)#ip dhcp snooping limit rate 50
    ```
-   (Опционально) Указать адрес авторизованного DHCP-сервера, доступного через доверенный порт:
    ```shell
    switch(config)#ip dhcp-server 10.84.168.253
    ```


#### <span class="section-num">5.2.3</span> Команды просмотра {#команды-просмотра}

-   Посмотреть состояние _DHCP snooping_:
    ```shell
    switch#show ip dhcp snooping
    ```
-   Просмотр базы данных привязки DHCP:
    ```shell
    switch#show ip dhcp snooping binding
    ```
