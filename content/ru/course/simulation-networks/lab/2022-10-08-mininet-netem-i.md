---
title: "Mininet. Использование netem (latency, jitter)"
author: ["Dmitry S. Kulyabov"]
date: 2022-10-08T21:33:00+03:00
lastmod: 2023-10-12T20:16:00+03:00
tags: ["network", "education"]
categories: ["computer-science"]
draft: false
weight: 203
toc: true
type: "book"
feedback: false
slug: "mininet-netem-i"
summary: "Использование netem (latency, jitter)"
linktitle: "Использование netem (latency, jitter)"
menu:
  "mininet-netem-i":
    parent: "simulation-networks-lab"
    weight: 203
    identifier: "mininet-netem-i"
---

Mininet. Использование netem. Задержки, джтиттер.

<!--more-->


## <span class="section-num">1</span> Общая информация {#общая-информация}

-   В этом лабораторном занятии вы познакомитесь с NETEM и объясните, как его можно использовать для имитации сценариев реального мира, при этом контролируя параметры, влияющие на производительность сетей.
-   Сетевые параметры включают задержку, дрожание, потерю пакетов, изменение порядка и повреждение (latency, jitter, packet loss, reordering, and corruption).
-   Значения корреляции между сетевыми параметрами также будут установлены для обеспечения большей реалистичности сетевой среды.


### <span class="section-num">1.1</span> Цели {#цели}

-   Освоить моделирование задержек и джиттера в сетях.


### <span class="section-num">1.2</span> Задачи {#задачи}

-   В ходе работы требуется освоить следующие понятия:
    -   что есть задержка в сетях и как ее измерить;
    -   что есть архитектура дисциплин очередей Linux (qdisc);
    -   освоить эмуляцию глобальных сети (характеризующихся большими задержками) с использованием netem и mininet;
    -   выполнить измерения после внесения задержек в эмулируемую глобальную сеть;
    -   развернуть эмулированные глобальные сети, характеризующиеся разными значениями задержки, джиттера и соответствующими значениями корреляции;
    -   задать разные распределения задержки эмулируемой глобальной сети.


### <span class="section-num">1.3</span> Видео: Использование netem I. Введение {#видео-использование-netem-i-dot-введение}

{{< tabs tabTotal="2" >}}
{{< rtab tabName="RuTube" >}}

{{< rutube f252186b156e3f19ea7a982411bfbd62 >}}

{{< /rtab >}}
{{< rtab tabName="Youtube" >}}

{{< youtube aeiuFANn5oY >}}

{{< /rtab >}}
{{< /tabs >}}


## <span class="section-num">2</span> Теоретические сведения {#теоретические-сведения}


### <span class="section-num">2.1</span> Дисциплины организации очередей в Linux {#дисциплины-организации-очередей-в-linux}

-   NETEM --- сетевой эмулятор Linux для тестирования производительности реальных приложений в виртуальной сети.
-   Виртуальная сеть может воспроизводить глобальные сети в лабораторной среде.
-   NETEM позволяет пользователю изменять такие параметры, как задержка, джиттер, потеря пакетов, дублирование и изменение порядка пакетов.
-   NETEM реализован в Linux и состоит из двух частей: модуля ядра для организации очередей и утилиты командной строки для его настройки.
-   Между протоколом IP и сетевым устройством создаётся очередь с дисциплиной обслуживания.
-   Дисциплина обслуживания очередей по умолчанию есть простая очередь пакетов FIFO (первым пришел --- первым обслужен).
-   Дисциплина реализуется как объект с двумя интерфейсами.
-   Один интерфейс ставит пакеты в очередь для отправки, а другой интерфейс отправляет пакеты на сетевое устройство.
-   На основе дисциплины обслуживания очередей принимается решение о том, какие пакеты отправлять, какие пакеты задерживать и какие пакеты отбрасывать.
-   Классовая дисциплина организации очередей, такая как NETEM, имеет настраиваемые внутренние модули.


### <span class="section-num">2.2</span> Глобальные сети и задержка {#глобальные-сети-и-задержка}

-   В сетях есть несколько процессов и устройств, которые способствуют сквозной задержке между узлом-отправителем и узлом-получателем.
-   Во многих случаях сквозная задержка определяется задержкой распространения в глобальной сети.
-   Рассмотрим два соседних коммутатора A и B, соединённых глобальной сетью.
    -   Как только бит передается в глобальную сеть коммутатором А, он должен пройти к коммутатору В.
    -   Время, необходимое для распространения от начала глобальной сети до коммутатора В, является задержкой распространения.
    -   Биты распространяются со скоростью канала.
    -   Скорость распространения зависит от физической среды (оптоволокно, медная витая пара и т. д.) и равно или немного меньше скорости света.
    -   Задержка распространения есть расстояние между двумя коммутатора, делённое на скорость распространения.
    -   Как только последний бит пакета передается на коммутатор B, он и все предыдущие биты пакета сохраняются на коммутаторе B.
-   Сетевые инструменты обычно оценивают задержку для устранения неполадок и измерения производительности.
-   Например, оценкой сквозной задержки является время двойного оборота (RTT), которое представляет собой время, необходимое пакету для прохождения от отправителя к получателю, а затем обратно к отправителю.
-   RTT включает задержки распространения пакетов, задержки в очереди пакетов в промежуточных маршрутизаторах и коммутаторах и обработку пакетов.
-   Если задержка распространения преобладает над другими компонентами задержки (как в случае глобальных сетей), то RTT является хорошей оценкой задержки распространения.


## <span class="section-num">3</span> Подготовка стенда {#подготовка-стенда}


### <span class="section-num">3.1</span> Лабораторная топология {#лабораторная-топология}

-   В топологии используется сеть 10.0.0.0/8, назначенная Mininet по умолчанию.
-   Топология представляет собой коммутатор с двумя подключёнными к нему хостами.
-   Для запуска топологии используем параметры командной строки:
    ```shell
    sudo mn --topo=single,2 -x
    ```


### <span class="section-num">3.2</span> Рабочие файлы {#рабочие-файлы}

-   Подключимся к виртуальной машине:
    ```shell
    ssh -Y mininet@192.168.x.y
    ```
-   Для рабочих файлов будем использовать каталог `~/work/lab_netem_i`:
    ```shell
    mkdir -p ~/work/lab_netem_i
    ```


## <span class="section-num">4</span> Интерактивный эксперимент {#интерактивный-эксперимент}


### <span class="section-num">4.1</span> Добавление/изменение задержки для эмуляции WAN {#добавление-изменение-задержки-для-эмуляции-wan}

-   Работа с NETEM осуществляется с помощью утилиты командной строки `tc`.
-   Без дополнительных параметров NETEM ведёт себя как базовая очередь FIFO без задержек, потерь, дублирования или переупорядочения пакетов.
-   Основной синтаксис `tc`, используемый с NETEM, следующий:
    ```shell
    sudo tc qdisc [add|del|replace|change|show] dev dev_id root netem opts
    ```

    -   `sudo`: выполнить команду с более высокими привилегиями;
    -   `tc`: команда, используемая для взаимодействия с NETEM;
    -   `qdisc`: дисциплина очереди (`qdisc`) представляет собой набор правил, определяющих порядок, в котором обслуживаются пакеты, поступающие по  протоколу IP.
        -   Дисциплина очереди применяется к очереди пакетов, чтобы решить, когда отправлять каждый пакет.
    -   `[add|del|replace|change|show]` (добавить, удалить, заменить, изменить, показать): операция над `qdisc`:
        -   чтобы добавить задержку на определённом интерфейсе, применяется операция `add`;
        -   чтобы изменить или удалить задержку на определённом интерфейсе, применяется операция `change` или `del`;
    -   `dev_id`: параметр указывает интерфейс, подлежащий эмуляции;
    -   `opts`: параметр указывает величину задержки, потери пакетов, дублирования, повреждения и другие.


### <span class="section-num">4.2</span> Определение интерфейсов хостов `h1` и `h2` {#определение-интерфейсов-хостов-h1-и-h2}

-   Необходимо идентифицировать интерфейсы на подключенных хостах.
-   На хосте `h1` введите команду `ifconfig`, чтобы отобразить информацию, относящуюся к его сетевым интерфейсам и назначенным им IP-адресам.
    -   Вывод команды `ifconfig` показывает, что хост `h1` имеет два интерфейса: `h1-eth0` и `lo`.
    -   Интерфейс `h1-eth0` необходимо использовать в `tc` при эмуляции WAN.
-   На хосте `h2` введите команду `ifconfig`.
-   Вывод команды `ifconfig` показывает, что хост `h2` имеет два интерфейса: `h2-eth0` и `lo`.
-   Интерфейс `h2-eth0` необходимо использовать в `tc` при эмуляции WAN.


### <span class="section-num">4.3</span> Добавка задержки для интерфейса, подключающегося к WAN {#добавка-задержки-для-интерфейса-подключающегося-к-wan}

-   Сетевые эмуляторы задают задержки на интерфейсе.
-   Например, задержка, вносимая в интерфейс коммутатора A, который подключён к интерфейсу коммутатора B, может представлять собой задержку распространения WAN, соединяющей оба коммутатора.
-   На хосте `h1` введите следующую команду:
    ```shell
    sudo tc qdisc add dev h1-eth0 root netem delay 100ms
    ```

    -   `sudo`: выполнить команду с более высокими привилегиями;
    -   `tc`: вызвать управление трафиком Linux;
    -   `qdisc`: изменить дисциплину очередей сетевого планировщика;
    -   `add`: создать новое правило;
    -   `dev h1-eth0`: указать интерфейс, на котором будет применяться правило;
    -   `netem`: использовать эмулятор сети;
    -   `delay 100ms`: задержка ввода 100 мс.
-   Эта команда добавляет задержку в 100 миллисекунд (мс) только к выходному интерфейсу.
-   Теперь пользователь может проверить, что соединение от хоста h1 к хосту h2 имеет задержку 100 миллисекунд, используя команду `ping` с хоста `h1`:
    ```shell
    ping 10.0.0.2
    ```
-   Все пакеты были получены успешно (0% потерь пакетов).
-   Задание: Запишите минимальное, среднее, максимальное и стандартное отклонение времени приёма-передачи (RTT).
-   Этот сценарий эмулирует задержку в 100 миллисекунд на интерфейсе узла `h1`, подключающегося к коммутатору.
-   Чтобы эмулировать глобальную сеть с двунаправленной задержкой, к соответствующему интерфейсу на хосте `h2` также необходимо добавить задержку в 100 миллисекунд.
-   В терминале хоста `h2` введите следующую команду:
    ```shell
    sudo tc qdisc add dev h2-eth0 root netem delay 100ms
    ```
-   Проверим, что соединение между хостом `h1` и хостом `h2` имеет `RTT` 200 миллисекунд (100 мс от хоста `h1` к хосту `h2` плюс 100 мс от хоста `h2` к хосту `h1`), повторив команду `ping` на терминале хоста `h1`:
    ```shell
    ping 10.0.0.2
    ```
-   Все пакеты были получены успешно (0% потерь пакетов).
-   Задание: Запишите минимальное, среднее, максимальное и стандартное отклонение времени приёма-передачи (RTT).


### <span class="section-num">4.4</span> Изменение задержки в эмулируемой глобальной сети {#изменение-задержки-в-эмулируемой-глобальной-сети}

-   Изменим задержку со 100 миллисекунд до 50 миллисекунд как для отправителя, так и для получателя. RTT теперь будет 100 миллисекунд.
-   В терминале хоста `h1` введите следующую команду:
    ```shell
    sudo tc qdisc change dev h1-eth0 root netem delay 50ms
    ```
-   Здесь добавлен новый параметр `change`, который изменяет ранее установленную задержку на 50 миллисекунд.
-   Применим также описанный выше шаг к терминалу хоста `h2`, чтобы изменить задержку на 50 мс:
    ```shell
    sudo tc qdisc change dev h2-eth0 root netem delay 50ms
    ```
-   Теперь можно проверить, что соединение от хоста `h1` к хосту `h2` имеет задержку 100 миллисекунд, используя команду `ping` с терминала хоста `h1`:
    ```shell
    ping 10.0.0.2
    ```
-   Все пакеты были получены успешно (0% потерь пакетов).
-   Задание: Запишите минимальное, среднее, максимальное и стандартное отклонение времени приёма-передачи (RTT).


### <span class="section-num">4.5</span> Восстановление исходных значений (удаление правил) {#восстановление-исходных-значений--удаление-правил}

-   Восстановим конфигурацию по умолчанию как для отправителя, так и для получателя, удалив все правила, применённые к сетевому планировщику интерфейса.
-   В терминале хоста `h1` введите следующую команду:
    ```shell
    sudo tc qdisc del dev h1-eth0 root netem
    ```
-   Добавлена новая опция `del`, которая удаляет ранее установленные правила для данного интерфейса.
-   В результате `tc qdisc` восстановит значения по умолчанию для устройства `h1-eth0`.
-   Применим те же действия для удаления правил на хосте `h2`. В терминале хоста `h2` введите следующую команду:
    ```shell
    sudo tc qdisc del dev h2-eth0 root netem
    ```
-   В результате дисциплина организации очереди `tc` восстановит свои значения по умолчанию для устройства `h2-eth0`.
-   Проверим, что соединение между хостом `h1` и хостом `h2` не имеет явно установленной задержки, используя команду `ping` с терминала хоста `h1`:
    ```shell
    ping 10.0.0.2
    ```
-   Все пакеты были получены успешно (0% потерь пакетов).
-   Задание: Запишите минимальное, среднее, максимальное и стандартное отклонение времени приёма-передачи (RTT).


### <span class="section-num">4.6</span> Добавление джиттера в интерфейс подключения к WAN {#добавление-джиттера-в-интерфейс-подключения-к-wan}

-   В сетях нет постоянной задержки. Задержка может варьироваться в зависимости от других потоков трафика, конкурирующих за тот же путь.
-   Джиттер --- это изменение времени задержки.
-   Параметры задержки описываются средним значением (\\(\mu\\)), стандартным отклонением (\\(\sigma\\)) и корреляцией.
-   По умолчанию NETEM использует _равномерное распределение_, так что задержка находится в пределах \\(\mu \pm \sigma\\).
-   Добавим задержку в 100 миллисекунд со случайным отклонением 10 миллисекунд.
-   _Прежде чем сделать это, необходимо восстановите конфигурацию интерфейсов по умолчанию на узлах `h1` и `h2`._

-   В терминале хоста `h1` введите команду:
    ```shell
    sudo tc qdisc add dev h1-eth0 root netem delay 100ms 10ms
    ```
-   Добавленное здесь новое значение представляет джиттер, который определяет вариацию задержки.
-   Все пакеты, покидающие хост `h1` через интерфейс `h1-eth0`, будут иметь задержку 100 мс со случайным отклонением ±10 мс.
-   Можно проверить, что соединение от хоста `h1` к хосту `h2` имеет задержку 100 мс со случайным отклонением ± 10 мс, с помощью команды `ping` на терминале хоста `h1`:
    ```shell
    ping 10.0.0.2
    ```
-   Все пакеты были получены успешно (0% потерь пакетов).
-   Задание: Запишите минимальное, среднее, максимальное и стандартное отклонение времени приёма-передачи (RTT).
-   В терминале хоста `h1` введите следующую команду, чтобы удалить предыдущие конфигурации:
    ```shell
    sudo tc qdisc del dev h1-eth0 root netem
    ```


### <span class="section-num">4.7</span> Добавление значения корреляции для джиттера и задержки {#добавление-значения-корреляции-для-джиттера-и-задержки}

-   Параметр корреляции управляет отношением между последовательными псевдослучайными значениями.
-   Добавим задержку в 100 миллисекунд с вариацией ±10 миллисекунд при добавлении значения корреляции.
-   _Прежде чем сделать это, необходимо восстановите конфигурацию интерфейсов по умолчанию на узлах `h1` и `h2`._
-   В терминале хоста `h1` введите следующую команду:
    ```shell
    sudo tc qdisc add dev h1-eth0 root netem delay 100ms 10ms 25%
    ```
-   Добавленное здесь новое значение представляет собой значение корреляции для джиттера и задержки.
-   Все пакеты, покидающие узел устройства `h1` на интерфейсе `h1-eth0`, будут иметь время задержки 100 мс со случайным отклонением ±10 мс, при этом следующий случайный пакет зависит от предыдущего на 25%.
-   Можно проверить соединение между хостами `h1` и `h2` с помощью команды `ping` на терминале хоста `h1`:
    ```shell
    ping 10.0.0.2
    ```
-   Все пакеты были получены успешно (0% потерь пакетов).
-   Задание: Запишите минимальное, среднее, максимальное и стандартное отклонение времени приёма-передачи (RTT).
-   В терминале хоста `h1` введите следующую команду, чтобы удалить предыдущие конфигурации:
    ```shell
    sudo tc qdisc del dev h1-eth0 root netem
    ```


### <span class="section-num">4.8</span> Распределение задержки {#распределение-задержки}

-   NETEM позволяет пользователю указать распределение, которое описывает, как задержки изменяются в сети.
-   Обычно задержки неравномерны, поэтому может быть удобно использовать неравномерное распределение, такое как нормальное, парето или парето-нормальное.
-   Можно указать нормальное распределение задержки в эмулируемой сети.
-   _Прежде чем сделать это, необходимо восстановите конфигурацию интерфейсов по умолчанию на узлах `h1` и `h2`._
-   В терминале хоста `h1` введите следующую команду:
    ```shell
    sudo tc qdisc add dev h1-eth0 root netem delay 100ms 20ms distribution normal
    ```
-   Добавленная здесь новая опция (`distribution`) задаёт тип распределения задержки.
-   Определим задержку так, чтобы она имела нормальное распределение, что обеспечивает более реалистичную эмуляцию сетей WAN.
-   Все пакеты, покидающие хост `h1` на интерфейсе `h1-eth0`, будут иметь время задержки, которое распределяется в диапазоне 100 мс ± 20 мс.
-   Используем команду `ping` на терминале хоста `h1`:
    ```shell
    ping 10.0.0.2
    ```
-   Все пакеты были получены успешно (0% потерь пакетов).
-   Задание: Запишите минимальное, среднее, максимальное и стандартное отклонение времени приёма-передачи (RTT).
-   В терминале хоста `h1` введите следующую команду, чтобы удалить предыдущие конфигурации:
    ```shell
    sudo tc qdisc del dev h1-eth0 root netem
    ```


### <span class="section-num">4.9</span> Видео: Использование netem I. Интерактивный эксперимент {#видео-использование-netem-i-dot-интерактивный-эксперимент}

{{< tabs tabTotal="2" >}}
{{< rtab tabName="RuTube" >}}

{{< rutube 1ea73a09806a25ae20bd3d34ebfb5247 >}}

{{< /rtab >}}
{{< rtab tabName="Youtube" >}}

{{< youtube wEuHronSk8M >}}

{{< /rtab >}}
{{< /tabs >}}


## <span class="section-num">5</span> Воспроизводимый эксперимент {#воспроизводимый-эксперимент}


### <span class="section-num">5.1</span> Постановка задания {#постановка-задания}

-   Будем исследовать задержки и построим графики для них.
-   Выполните все интерактивные эксперименты в виде воспроизводимых.
-   Для каждого эксперимента `expname` создайте свой каталог:
    ```shell
    mkdir -p ~/work/lab_netem_i/expname
    ```
-   В него мы будем помещать файлы эксперимента.
-   Для каждого эксперимента создайте скрипт для проведения эксперимента `lab_netem_i.py` и скрипт для визуализации `ping_plot`.
-   Кроме визуализации вычислите минимальное, среднее, максимальное и стандартное отклонение времени приёма-передачи.
-   Для примера реализуем задание простейшей задержки.


### <span class="section-num">5.2</span> Добавка задержки для интерфейса, подключающегося к WAN {#добавка-задержки-для-интерфейса-подключающегося-к-wan}

-   Создадим каталог `simple-delay`:
    ```shell
    mkdir -p ~/work/lab_netem_i/simple-delay
    cd ~/work/lab_netem_i/simple-delay
    ```
-   Создадим скрипт для эксперимента `lab_netem_i.py`:
    ```python
    #!/usr/bin/env python

    """
    Simple experiment.
    Output: ping.dat
    """

    from mininet.net import Mininet
    from mininet.node import Controller
    from mininet.cli import CLI
    from mininet.log import setLogLevel, info
    import time

    def emptyNet():

        "Create an empty network and add nodes to it."

        net = Mininet( controller=Controller, waitConnected=True )

        info( '*** Adding controller\n' )
        net.addController( 'c0' )

        info( '*** Adding hosts\n' )
        h1 = net.addHost( 'h1', ip='10.0.0.1' )
        h2 = net.addHost( 'h2', ip='10.0.0.2' )

        info( '*** Adding switch\n' )
        s1 = net.addSwitch( 's1' )

        info( '*** Creating links\n' )
        net.addLink( h1, s1 )
        net.addLink( h2, s1 )

        info( '*** Starting network\n')
        net.start()

        info( '*** Set delay\n')
        h1.cmdPrint( 'tc qdisc add dev h1-eth0 root netem delay 100ms' )
        h2.cmdPrint( 'tc qdisc add dev h2-eth0 root netem delay 100ms' )

        time.sleep(10)  # Wait 10 seconds

        info( '*** Ping\n')
        h1.cmdPrint( 'ping -c 100', h2.IP(), '| grep "time=" | awk \'{print $5, $7}\' | sed -e \'s/time=//g\' -e \'s/icmp_seq=//g\' > ping.dat' )

        info( '*** Stopping network' )
        net.stop()


    if __name__ == '__main__':
        setLogLevel( 'info' )
        emptyNet()
    ```
-   Создадим скрипт для визуализации `ping_plot`:
    ```shell
    #!/usr/bin/gnuplot --persist

    set terminal png crop
    set output 'ping.png'
    set xlabel "Sequence number"
    set ylabel "Delay (ms)"
    set grid
    plot "ping.dat" with lines
    ```
-   Зададим права доступа:
    ```shell
    chmod +x ping_plot
    ```
-   Создадим `Makefile`:
    ```makefile
    all: ping.dat ping.png

    ping.dat:
            sudo python lab_netem_i.py
            sudo chown mininet:mininet ping.dat

    ping.png: ping.dat
            ./ping_plot

    clean:
            -rm -f *.dat *.png
    ```
-   Выполним эксперимент:
    ```shell
    make
    ```
-   Посмотрите график.
-   Вычислите минимальное, среднее, максимальное и стандартное отклонение времени приёма-передачи.


### <span class="section-num">5.3</span> Видео: Использование netem I. Воспроизводимый эксперимент {#видео-использование-netem-i-dot-воспроизводимый-эксперимент}

{{< tabs tabTotal="2" >}}
{{< rtab tabName="RuTube" >}}

{{< rutube a202f653206b1c569bcfe44b5924558a >}}

{{< /rtab >}}
{{< rtab tabName="Youtube" >}}

{{< youtube _EBurmbB9DY >}}

{{< /rtab >}}
{{< /tabs >}}
