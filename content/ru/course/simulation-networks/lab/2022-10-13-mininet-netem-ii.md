---
title: "Mininet. Использование netem (потери пакетов)"
author: ["Dmitry S. Kulyabov"]
date: 2022-10-13T14:27:00+03:00
lastmod: 2022-11-23T19:33:00+03:00
tags: ["network", "education"]
categories: ["computer-science"]
draft: false
weight: 204
toc: true
type: "book"
slug: "mininet-netem-ii"
summary: "Использование netem (потери пакетов)"
linktitle: "Использование netem (потери пакетов)"
menu:
  "mininet-netem-ii":
    parent: "simulation-networks-lab"
    weight: 204
    identifier: "mininet-netem-ii"
---

Использование netem. Потери пакетов, дублирование пакетов, изменение порядка, повреждение пакетов.

<!--more-->


## <span class="section-num">1</span> Общая информация {#общая-информация}


### <span class="section-num">1.1</span> Цели {#цели}

-   Освоить моделирование следующих параметров сети: потеря пакетов, дублирование пакетов, изменение порядка и повреждение пакетов.


### <span class="section-num">1.2</span> Задачи {#задачи}

-   В ходе работы требуется освоить следующие умения:
    -   эмуляция  сети, характеризующихся такими параметрами, как задержка, потеря пакетов, повреждение пакетов, переупорядочивание пакетов и дублирование пакетов;
    -   измерение производительности глобальных сетей, характеризующихся различными значениями параметров.


### <span class="section-num">1.3</span> Видео: Использование netem II. Введение {#видео-использование-netem-ii-dot-введение}

{{< tabs tabTotal="2" >}}
{{< rtab tabName="RuTube" >}}

{{< rutube dbb8edc601a8941aa093a15303b5391d >}}

{{< /rtab >}}
{{< rtab tabName="Youtube" >}}

{{< youtube E6yKPh6Vhq4 >}}

{{< /rtab >}}
{{< /tabs >}}


## <span class="section-num">2</span> Теоретические сведения {#теоретические-сведения}


### <span class="section-num">2.1</span> Проблемы с передачей пакетов {#проблемы-с-передачей-пакетов}

1.  Потеря пакета
    -   Пакет, проходящий через сеть, не достигает пункта назначения.
    -   Распространённой причиной потери пакетов является неспособность маршрутизаторов удерживать пакеты, поступающие со скоростью, превышающей скорость отправления.
    -   Маршрутизатор ограничен объёмом буферной памяти, используемой для мгновенного хранения пакетов.
    -   Когда происходит потеря пакетов, TCP уменьшает окно перегрузки и, следовательно, пропускную способность вдвое.
2.  Переупорядочивание пакетов
    -   Пакеты принимаются в порядке, отличном от того, в котором они были отправлены.
    -   Переупорядочивание пакетов (неупорядоченная доставка пакетов) обычно является результатом того, что пакеты следуют по разным маршрутам для достижения пункта назначения.
    -   Переупорядочивание пакетов может ухудшить пропускную способность TCP-соединений в сетях с высокой пропускной способностью и высокой задержкой.
    -   Для каждого сегмента, полученного не по порядку, получатель TCP отправляет подтверждение (ACK) для последнего правильно принятого сегмента.
    -   Как только отправитель TCP получает три подтверждения для одного и того же сегмента (тройной дубликат ACK), отправитель считает, что получатель неправильно принял пакет, следующий за пакетом, который подтверждается три раза.
    -   Тогда отправитель уменьшает окно перегрузки и пропускную способность в два раза.
3.  Повреждение пакета
    -   Повреждение битов, составляющих пакет.
    -   Обычно происходит на физическом уровне.
    -   В случае повреждения некоторые биты могут иметь значения, отличные от первоначально отправленных узлом-отправителем.
    -   Узел получателя отбрасывает такие пакеты.
    -   Процесс-отправитель TCP не получит подтверждения для соответствующего сегмента и будет считать его потерянным сегментом.
    -   Отправитель уменьшает окно перегрузки и пропускную способность в два раза.
4.  Дублирование пакетов
    -   Несколько копий пакета присутствуют в сети и принимаются пунктом назначения.
    -   Дублирование пакетов является результатом повторных передач, когда узел-отправитель повторно передает неподтвержденные (NACK) пакеты.


## <span class="section-num">3</span> Подготовка стенда {#подготовка-стенда}


### <span class="section-num">3.1</span> Лабораторная топология {#лабораторная-топология}

-   В топологии используется сеть 10.0.0.0/8, назначенная Mininet по умолчанию.
-   Топология представляет собой коммутатор с двумя подключёнными к нему хостами.
-   Для запуска топологии (рис. [1](#figure--fig:netem-ii:topology)) используем параметры командной строки:
    ```shell
    sudo mn --topo=single,2 -x
    ```
    <a id="figure--fig:netem-ii:topology"></a>

    <figure>
    <svg
    xmlns="http://www.w3.org/2000/svg"
    xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css"
    height="120px" preserveAspectRatio="none"
    style="width:453px;height:120px;background:#FFFFFF;" version="1.1"
    viewBox="0 0 453 120" width="453px"
    zoomAndPan="magnify"><defs/><g><g id="elem_h1"><polygon fill="#F1F1F1"
    points="9.5,7,9.5,7.2102,19.5,6.5857,29.5,7.1933,39.5,7.3997,49.5,6.2866,59.5,6.9223,69.5,7,69.4456,6.8687,69.8046,7.0283,70.1984,7.2719,70.4725,7.2264,70.9848,7.7563,71.2678,7.7322,71.0737,7.6518,71.3533,8.0606,71.6937,8.4944,71.6807,8.782,71.8746,9.1552,72,9.5,71.9681,9.5,72.1785,19.7318,72.2391,29.9635,72.5857,40.1953,72.6711,50.427,72.6793,60.6588,72.2546,70.8905,72.4636,81.1223,72.7022,91.354,71.2788,101.5858,72,111.8175,72.209,111.9041,71.7622,112.1332,71.8715,112.5927,71.4082,112.815,71.3931,113.223,71.2678,113.5853,71.3624,113.8137,70.908,113.7167,70.5741,113.9106,70.2503,114.1289,69.9066,114.2992,69.5,114.3175,69.5,114.3136,59.5,114.6047,49.5,113.7451,39.5,114.6019,29.5,114.8657,19.5,114.762,9.5,114.3175,9.5782,114.5063,9.0848,114.0223,8.7097,113.8238,8.3601,113.6868,8.0783,113.7136,7.7322,113.5853,7.6717,113.5602,7.7956,113.3186,7.3855,112.8559,7.1872,112.4809,7.2167,112.2002,7,111.8175,6.3332,111.8175,6.4809,101.5858,7.649,91.354,7.4357,81.1223,7.7345,70.8905,6.6782,60.6588,7.3192,50.427,7.5904,40.1953,6.5276,29.9635,6.9041,19.7318,7,9.5,7.0388,9.5161,7.3472,9.2296,7.2916,8.7924,7.5818,8.4983,7.4152,8.0151,7.7322,7.7322,7.6458,7.5237,8.15,7.7409,8.3479,7.2186,8.8578,7.4496,9.1728,7.2101,9.5,7"
    style="stroke:#181818;stroke-width:0.5;"/><image height="48"
    width="45" x="17"
    xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAC0AAAAwCAIAAAAKMGSIAAABA0lEQVR42u2Z0Q3DIAxEsyIjMAIjdARGYARG6AiM0BG6QU9FQlEkiE0MJarvLwpOHuYi2c72XkPbWhwpJeec4QtRiBXj6IMoKGIc5pqUYwJHomk4BzFS/aEcyqEcN+Lw3j+bmsEhUl5c5Qgh4C52bMYImSZxiLinrXysDA4vrfzYGCOPQ9wTyqEcyqEcgzgeO/2Soxbwr/lQn67JUQtAbRZFdcLx2mlCPUY6l7yosIurfJLn9XrJCn0cwo2l9i9wRmMw1Jg4Du/nQIY6GxBlx8jwYY21ls3B8vkh27isGQhFObEN65xr48X2K3oKsbi4Uoyje/5cc24nRz4Lrhod+Sr/Gz6joejQ6zC0iQAAAABJRU5ErkJggg=="
    y="17"/><text fill="#000000" font-family="xkcd Script" font-size="14"
    lengthAdjust="spacing" textLength="10" x="36.5"
    y="80.2429">h1</text><text fill="#000000" font-family="xkcd Script"
    font-size="14" lengthAdjust="spacing" textLength="39" x="20"
    y="99.9017">10.0.0.1</text></g><g id="elem_h2"><polygon fill="#F1F1F1"
    points="384.5,7,384.5,7.2102,394.5,6.5857,404.5,7.1933,414.5,7.3997,424.5,6.2866,434.5,6.9223,444.5,7,444.4456,6.8687,444.8046,7.0283,445.1984,7.2719,445.4725,7.2264,445.9848,7.7563,446.2678,7.7322,446.0737,7.6518,446.3533,8.0606,446.6937,8.4944,446.6807,8.782,446.8746,9.1552,447,9.5,446.9681,9.5,447.1785,19.7318,447.2391,29.9635,447.5857,40.1953,447.6711,50.427,447.6793,60.6588,447.2546,70.8905,447.4636,81.1223,447.7022,91.354,446.2788,101.5858,447,111.8175,447.209,111.9041,446.7622,112.1332,446.8715,112.5927,446.4082,112.815,446.3931,113.223,446.2678,113.5853,446.3624,113.8137,445.908,113.7167,445.5741,113.9106,445.2503,114.1289,444.9066,114.2992,444.5,114.3175,444.5,114.3136,434.5,114.6047,424.5,113.7451,414.5,114.6019,404.5,114.8657,394.5,114.762,384.5,114.3175,384.5782,114.5063,384.0848,114.0223,383.7097,113.8238,383.3601,113.6868,383.0783,113.7136,382.7322,113.5853,382.6717,113.5602,382.7956,113.3186,382.3855,112.8559,382.1872,112.4809,382.2167,112.2002,382,111.8175,381.3332,111.8175,381.4809,101.5858,382.649,91.354,382.4357,81.1223,382.7345,70.8905,381.6782,60.6588,382.3192,50.427,382.5904,40.1953,381.5276,29.9635,381.9041,19.7318,382,9.5,382.0388,9.5161,382.3472,9.2296,382.2916,8.7924,382.5818,8.4983,382.4152,8.0151,382.7322,7.7322,382.6458,7.5237,383.15,7.7409,383.3479,7.2186,383.8578,7.4496,384.1728,7.2101,384.5,7"
    style="stroke:#181818;stroke-width:0.5;"/><image height="48"
    width="45" x="392"
    xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAC0AAAAwCAIAAAAKMGSIAAABA0lEQVR42u2Z0Q3DIAxEsyIjMAIjdARGYARG6AiM0BG6QU9FQlEkiE0MJarvLwpOHuYi2c72XkPbWhwpJeec4QtRiBXj6IMoKGIc5pqUYwJHomk4BzFS/aEcyqEcN+Lw3j+bmsEhUl5c5Qgh4C52bMYImSZxiLinrXysDA4vrfzYGCOPQ9wTyqEcyqEcgzgeO/2Soxbwr/lQn67JUQtAbRZFdcLx2mlCPUY6l7yosIurfJLn9XrJCn0cwo2l9i9wRmMw1Jg4Du/nQIY6GxBlx8jwYY21ls3B8vkh27isGQhFObEN65xr48X2K3oKsbi4Uoyje/5cc24nRz4Lrhod+Sr/Gz6joejQ6zC0iQAAAABJRU5ErkJggg=="
    y="17"/><text fill="#000000" font-family="xkcd Script" font-size="14"
    lengthAdjust="spacing" textLength="15" x="409"
    y="80.2429">h2</text><text fill="#000000" font-family="xkcd Script"
    font-size="14" lengthAdjust="spacing" textLength="44" x="392.5"
    y="99.9017">10.0.0.2</text></g><g id="elem_s1"><polygon fill="#F1F1F1"
    points="195.5,31.5,195.5,31.7102,206,31.0857,216.5,31.6933,227,31.8997,237.5,30.7866,248,31.4223,258.5,31.5,258.4456,31.3687,258.8046,31.5283,259.1984,31.7719,259.4725,31.7264,259.9848,32.2563,260.2678,32.2322,260.0737,32.1518,260.3533,32.5606,260.6937,32.9944,260.6807,33.282,260.8746,33.6552,261,34,260.9681,34,261.1785,44.5318,261.2391,55.0635,261.5857,65.5953,261.6711,76.127,261,86.6588,261.2092,86.7454,260.932,87.0448,260.8499,87.425,260.7769,87.809,260.1921,87.981,260.2678,88.4265,260.3543,88.6355,259.8764,88.4817,259.6288,88.8838,259.144,88.7134,258.8448,88.9912,258.5,89.1588,258.5,89.9004,248,89.11,237.5,89.2641,227,89.4974,216.5,89.575,206,89.1549,195.5,89.1588,195.5366,89.2472,195.0734,88.836,194.8292,88.9534,194.5093,88.8882,194.1425,88.7099,193.7322,88.4265,193.921,88.5047,193.437,88.0113,193.2385,87.6362,193.1015,87.2866,193.1283,87.0048,193,86.6588,192.8035,86.6588,193.6814,76.127,192.8253,65.5953,192.6569,55.0635,193.2283,44.5318,193,34,192.7946,33.9149,192.9866,33.5802,193.4927,33.3757,193.5735,32.9949,193.812,32.6795,193.7322,32.2322,193.6912,32.1331,194.1265,32.1841,194.5147,32.1212,194.7326,31.6474,195.1342,31.6169,195.5,31.5"
    style="stroke:#181818;stroke-width:0.5;"/><image height="18"
    width="48" x="203"
    xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAASCAIAAACSBMrtAAAAyElEQVR42s2V4RHDIAiFs2JGcARHcARHcARHYARHcIRuUC7cpZDCNVov+n4SHvkCaLbXYtrWBUop7ZPkvS+lCKAY4z5btdYPEA89L2oHNUkAqdkAoMbLoSGWnDO+nVw/gChVrTLccgsIh4h56iitz+2w3ALCipelOx/hoeDxEEK3ZQzQ96FttTjnekYGUrzzPM6n02Fp2yFMsq4DbMyl89yi7oplaQDCuhYQlsb7o8kSD/0F9IxMIJgkuqkVoLkSQLCAxM91Hb0BP+CVCm8acDEAAAAASUVORK5CYII="
    y="41.5"/><text fill="#000000" font-family="xkcd Script"
    font-size="14" lengthAdjust="spacing" textLength="9" x="224.5"
    y="74.7429">s1</text></g><g id="link_h1_s1"><path d="M72.39,60.5 L72.39,60.7802
    L82.4383,59.9476 L92.4867,60.7577 L102.535,61.0329 L112.5833,59.5488
    L122.6317,60.3964 L132.68,59.9313 L142.7283,59.9887 L152.7767,60.4091
    L162.825,59.5782 L172.8733,61.2382 L182.9217,59.6596 L192.97,60.5 "
    fill="none" style="stroke:#181818;stroke-width:1.0;"/><text
    fill="#000000" font-family="xkcd Script" font-size="13"
    lengthAdjust="spacing" textLength="43" x="80.0386"
    y="75.9155">h1-eth0</text><text fill="#000000" font-family="xkcd
    Script" font-size="13" lengthAdjust="spacing" textLength="38"
    x="146.8498"
    y="76.0781">s1-eth1</text></g><g id="link_s1_h2"><path d="M261.16,60.5
    L261.16,60.7802 L271.2183,59.9476 L281.2767,60.7577 L291.335,61.0329
    L301.3933,59.5488 L311.4517,60.3964 L321.51,59.9313 L331.5683,59.9887
    L341.6267,60.4091 L351.685,59.5782 L361.7433,61.2382 L371.8017,59.6596
    L381.86,60.5 " fill="none"
    style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000"
    font-family="xkcd Script" font-size="13" lengthAdjust="spacing"
    textLength="42" x="268.9169" y="75.9618">s1-eth2</text><text
    fill="#000000" font-family="xkcd Script" font-size="13"
    lengthAdjust="spacing" textLength="47" x="326.9653"
    y="75.9155">h2-eth0</text></g></g></svg>
    <figcaption>

      <span class="figure-number">&#1056;&#1080;&#1089;. 1.: </span>Лабораторная топология
    </figcaption>
    </figure>


### <span class="section-num">3.2</span> Рабочие файлы {#рабочие-файлы}

-   Подключимся к виртуальной машине:
    ```shell
    ssh -Y mininet@192.168.x.y
    ```
-   Для рабочих файлов будем использовать каталог `~/work/lab_netem_ii`:
    ```shell
    mkdir -p ~/work/lab_netem_ii
    ```


## <span class="section-num">4</span> Интерактивный эксперимент {#интерактивный-эксперимент}


### <span class="section-num">4.1</span> Добавление/изменение потери пакетов {#добавление-изменение-потери-пакетов}

-   Работа с NETEM осуществляется с помощью утилиты командной строки `tc`.
-   Без дополнительных параметров NETEM ведёт себя как базовая очередь FIFO без задержек, потерь, дублирования или переупорядочения пакетов.
-   Основной синтаксис `tc`, используемый с NETEM, следующий:
    ```shell
    sudo tc qdisc [add|del|replace|change|show] dev dev_id root netem opts
    ```

    -   `sudo`: выполнить команду с более высокими привилегиями;
    -   `tc`: команда, используемая для взаимодействия с NETEM;
    -   `qdisc`: дисциплина очереди (`qdisc`) представляет собой набор правил, определяющих порядок, в котором обслуживаются пакеты, поступающие по  протоколу IP.
        -   Дисциплина очереди применяется к очереди пакетов, чтобы решить, когда отправлять каждый пакет.
    -   `[add|del|replace|change|show]` (добавить, удалить, заменить, изменить, показать): операция над `qdisc`:
        -   чтобы добавить задержку на определённом интерфейсе, применяется операция `add`;
        -   чтобы изменить или удалить задержку на определённом интерфейсе, применяется операция `change` или `del`;
    -   `dev_id`: параметр указывает интерфейс, подлежащий эмуляции;
    -   `opts`: параметр указывает величину задержки, потери пакетов, дублирования, повреждения и другие.


### <span class="section-num">4.2</span> Определение интерфейсов хостов `h1` и `h2` {#определение-интерфейсов-хостов-h1-и-h2}

-   Необходимо идентифицировать интерфейсы на подключенных хостах.
-   На хосте `h1` введите команду `ifconfig`, чтобы отобразить информацию, относящуюся к его сетевым интерфейсам и назначенным им IP-адресам.
    -   Вывод команды `ifconfig` показывает, что хост `h1` имеет два интерфейса: `h1-eth0` и `lo`.
    -   Интерфейс `h1-eth0` необходимо использовать в `tc` при эмуляции WAN.
-   На хосте `h2` введите команду `ifconfig`.
-   Вывод команды `ifconfig` показывает, что хост `h2` имеет два интерфейса: `h2-eth0` и `lo`.
-   Интерфейс `h2-eth0` необходимо использовать в `tc` при эмуляции WAN.


### <span class="section-num">4.3</span> Добавка потери пакетов на интерфейс, подключённый к глобальной сети {#добавка-потери-пакетов-на-интерфейс-подключённый-к-глобальной-сети}

-   Пакеты могут быть потеряны во время передачи из-за таких факторов, как битовые ошибки и перегрузка сети.
-   Скорость потерянных пакетов часто измеряется как процентная доля потерянных пакетов по отношению к количеству отправленных пакетов.
-   В терминале хоста `h1` введите следующую команду:
    ```shell
    tc qdisc add dev h1-eth0 root netem loss 10%
    ```
-   Эта команда добавляет 10% потери пакетов к интерфейсу `h1-eth0` хоста `h1`.
-   Теперь можно проверить наличие потерь пакетов, используя команду `ping` с терминала хоста `h1`. Параметр `-c` указывает общее количество пакетов для отправки:
    ```shell
    ping 10.0.0.2 -c 200
    ```
-   Обратите внимание на значения `icmp_seq`. Некоторые номера последовательности отсутствуют из-за потери пакетов.
-   В сводном отчёте `ping` сообщает о проценте потерянных пакетов после завершения передачи.
-   Данный сценарий эмулирует 10% потери пакетов в однонаправленном канале от хоста `h1` к хосту `h2`.
-   Если мы хотим эмулировать потерю пакетов в обоих направлениях, к хосту `h2` также необходимо добавить потерю пакетов в размере 10%.
-   В терминале хоста `h2` введите следующую команду:
    ```shell
    tc qdisc add dev h2-eth0 root netem loss 10%
    ```
-   Можно убедиться, что соединение между хостом `h1` и хостом `h2` имеет больше потерь пакетов (10% от хоста `h1` + 10% от хоста `h2`), повторив команду `ping` на терминале хоста `h1`:
    ```shell
    ping 10.0.0.2 -c 200
    ```
-   Обратите внимание на значения `icmp_seq`. Некоторые номера последовательности отсутствуют из-за потери пакетов.
-   В сводном отчёте `ping` сообщает о проценте потерянных пакетов после завершения передачи.
-   Чтобы удалить добавленную потерю пакетов и восстановить конфигурацию по умолчанию, необходимо удалить правила интерфейсов на хосте `h1` и хосте `h2`.
-   В терминале хоста `h1` введите следующую команду:
    ```shell
    tc qdisc del dev h1-eth0 root netem
    ```
-   Примените те же действия для удаления правил на хосте `h2`. В терминале хоста `h2` введите следующую команду:
    ```shell
    tc qdisc del dev h2-eth0 root netem
    ```
-   В результате дисциплина организации очереди tc восстановит свои значения по умолчанию.
-   Теперь можно убедиться, что соединение от хоста `h1` к хосту `h2` не имеет явной потери пакетов.
-   Запустите команду `ping` с терминала хоста `h1`:
    ```shell
    ping 10.0.0.2
    ```
-   Нажмите `Ctrl+c`, чтобы остановить тест.


### <span class="section-num">4.4</span> Добавка значения корреляции для потери пакетов {#добавка-значения-корреляции-для-потери-пакетов}

-   Можно добавить необязательную корреляцию.
-   В терминале хоста `h1` введите следующую команду:
    ```shell
    tc qdisc add dev h1-eth0 root netem loss 50% 50%
    ```
-   Команда вводит коэффициент потери пакетов 50% (такой высокий уровень потери пакетов маловероятен), и каждая последующая вероятность зависит на 50% от последней.
-   Теперь пользователь может проверить, что между хостом `h1` и хостом `h2` теряются пакеты, используя команду `ping` с терминала хоста `h1`:
    ```shell
    ping 10.0.0.2 -c 50
    ```
-   Обратите внимание на значения `icmp_seq`. Некоторые номера последовательности отсутствуют из-за потери пакетов.
-   В сводном отчёте `ping` сообщает о проценте потерянных пакетов после завершения передачи.
-   В терминале хоста `h1` введите следующую команду, чтобы удалить предыдущие конфигурации:
    ```shell
    tc qdisc del dev h1-eth0 root netem
    ```


### <span class="section-num">4.5</span> Добавка повреждения пакетов {#добавка-повреждения-пакетов}

-   Помимо потери пакетов, с помощью NETEM можно эмулировать повреждение пакетов.
-   В терминале хоста `h1` введите следующую команду:
    ```shell
    tc qdisc add dev h1-eth0 root netem corrupt 0.01%
    ```
-   Добавленное здесь новое значение представляет собой процент повреждения пакетов (0,01%).
-   Теперь пользователь может проверить предыдущую конфигурацию с помощью инструмента `iperf3` для проверки повторных передач.
-   Запустите iPerf3 в режиме сервера в терминале хоста `h2`:
    ```shell
    iperf3 -s
    ```
-   Запустите iPerf3 в клиентском режиме в терминале хоста `h1`:
    ```shell
    iperf3 -c 10.0.0.2
    ```
-   Посмотрите значения повторной передачи на каждом временном интервале и общее количество повторно переданных пакетов.
-   В терминале хоста `h1` введите следующую команду, чтобы удалить предыдущие конфигурации:
    ```shell
    tc qdisc del dev h1-eth0 root netem
    ```
-   Чтобы остановить сервер, нажмите `Ctrl+c` в терминале хоста `h2`.


### <span class="section-num">4.6</span> Добавка переупорядочивание пакетов {#добавка-переупорядочивание-пакетов}

-   Иногда пакеты доставляются не в том порядке, в котором они были отправлены.
-   Для эмуляции переупорядочивания в NETEM используется опция переупорядочивания.
-   Посмотрим поведение трафика без переупорядочивания пакетов.
-   В терминале хоста `h1` введём:
    ```shell
    ping 10.0.0.2
    ```
-   Нажмите `Ctrl+c`, чтобы остановить тест.
-   В терминале хоста `h1` введите следующую команду:
    ```shell
    tc qdisc add dev h1-eth0 root netem delay 10ms reorder 25% 50%
    ```
-   В этой команде 25% пакетов (со значением корреляции 50%) будут отправлены немедленно, а остальные 75% будут задержаны на 10 мс.
-   Пользователь может проверить эффект переупорядочивания пакетов с помощью команды `ping` на терминале хоста `h1` (нажмите `Ctrl+c`, чтобы остановить тест):
    ```shell
    ping 10.0.0.2
    ```
-   Первый и второй пакеты не будут иметь задержки (один из четырех, или 25%), а следующие три пакета будут иметь задержку около 10 миллисекунд (три из четырех, или 75%).
-   В терминале хоста `h1` введите следующую команду, чтобы удалить предыдущие конфигурации:
    ```shell
    tc qdisc del dev h1-eth0 root netem
    ```


### <span class="section-num">4.7</span> Добавка дублирования пакетов {#добавка-дублирования-пакетов}

-   Дублированные пакеты могут присутствовать в сетях в результате повторных передач.
-   NETEM предоставляет возможность эмуляции дублирования пакетов.
-   В терминале хоста `h1` введите следующую команду:
    ```shell
    tc qdisc add dev h1-eth0 root netem duplicate 50%
    ```
-   Команда создаст дублирование 50% (т. е. 50% пакетов будут получены дважды).
-   Пользователь может проверить эффект дублирования пакетов с помощью команды `ping` на терминале хоста `h1` (нажмите `Ctrl+c`, чтобы остановить тест):
    ```shell
    ping 10.0.0.2
    ```
-   Дубликаты пакетов помечаются как `DUP!`.
-   Измеренная скорость дублирования пакетов будет приближаться к настроенной скорости по мере выполнения большего количества попыток.
-   В терминале хоста `h1` введите следующую команду, чтобы удалить предыдущие конфигурации:
    ```shell
    tc qdisc del dev h1-eth0 root netem
    ```


### <span class="section-num">4.8</span> Видео: Использование netem II. Интерактивный эксперимент {#видео-использование-netem-ii-dot-интерактивный-эксперимент}

{{< tabs tabTotal="2" >}}
{{< rtab tabName="RuTube" >}}

{{< rutube b374d511a828ef5d969a6c538f9d18b1 >}}

{{< /rtab >}}
{{< rtab tabName="Youtube" >}}

{{< youtube l061lvu_8w4 >}}

{{< /rtab >}}
{{< /tabs >}}


## <span class="section-num">5</span> Воспроизводимый эксперимент {#воспроизводимый-эксперимент}


### <span class="section-num">5.1</span> Постановка задания {#постановка-задания}

-   Будем исследовать задержки и построим графики для них.
-   Выполните все интерактивные эксперименты в виде воспроизводимых.
-   Для каждого эксперимента `expname` создайте свой каталог:
    ```shell
    mkdir -p ~/work/lab_netem_ii/expname
    ```
-   В него мы будем помещать файлы эксперимента.
-   Здесь `expname` может принимать значения `simple-drop`, `correlation-drop` и т.п.
-   Для каждого эксперимента создайте скрипт для проведения эксперимента `lab_netem_i.py` и скрипт для визуализации `ping_plot`.
-   Кроме визуализации вычислите минимальное, среднее, максимальное и стандартное отклонение времени приёма-передачи.
-   Для примера реализуем задание простейшей задержки.


### <span class="section-num">5.2</span> Добавление потери пакетов на интерфейс, подключённый к эмулируемой глобальной сети {#добавление-потери-пакетов-на-интерфейс-подключённый-к-эмулируемой-глобальной-сети}

-   В качестве примера исследуем
-   Создадим каталог `simple-drop`:
    ```shell
    mkdir -p ~/work/lab_netem_ii/simple-drop
    cd ~/work/lab_netem_ii/simple-drop
    ```
-   Создадим скрипт для эксперимента `lab_netem_ii.py`:
    ```python
    #!/usr/bin/env python

    """
    Simple experiment.
    Output: ping.dat
    """

    from mininet.net import Mininet
    from mininet.node import Controller
    from mininet.cli import CLI
    from mininet.log import setLogLevel, info
    import time

    def emptyNet():

        "Create an empty network and add nodes to it."

        net = Mininet( controller=Controller, waitConnected=True )

        info( '*** Adding controller\n' )
        net.addController( 'c0' )

        info( '*** Adding hosts\n' )
        h1 = net.addHost( 'h1', ip='10.0.0.1' )
        h2 = net.addHost( 'h2', ip='10.0.0.2' )

        info( '*** Adding switch\n' )
        s1 = net.addSwitch( 's1' )

        info( '*** Creating links\n' )
        net.addLink( h1, s1 )
        net.addLink( h2, s1 )

        info( '*** Starting network\n')
        net.start()

        info( '*** Set loss\n')
        h1.cmdPrint( 'tc qdisc add dev h1-eth0 root netem loss 10%' )
        h2.cmdPrint( 'tc qdisc add dev h2-eth0 root netem loss 10%' )

        time.sleep(10)  # Wait 10 seconds

        info( '*** Ping\n')
        h1.cmdPrint( 'ping -c 200', h2.IP(), '| grep "time=" | awk \'{print $5, $7}\' | sed -e \'s/time=//g\' -e \'s/icmp_seq=//g\' > ping.dat' )

        info( '*** Stopping network' )
        net.stop()


    if __name__ == '__main__':
        setLogLevel( 'info' )
        emptyNet()
    ```
-   Создадим скрипт для визуализации `ping_plot`:
    ```shell
    #!/usr/bin/gnuplot --persist

    set terminal png crop
    set output 'ping.png'
    set xlabel "Sequence number"
    set ylabel "Delay (ms)"
    set grid
    plot "ping.dat" with lines
    ```
-   Зададим права доступа:
    ```shell
    chmod +x ping_plot
    ```
-   Создадим `Makefile`:
    ```makefile
    all: ping.dat ping.png

    ping.dat:
    	sudo python lab_netem_i.py
    	sudo chown mininet:mininet ping.dat

    ping.png: ping.dat
    	./ping_plot

    clean:
    	-rm -f *.dat *.png
    ```
-   Выполним эксперимент:
    ```shell
    make
    ```
-   Посмотрите график.
-   Вычислите минимальное, среднее, максимальное и стандартное отклонение времени приёма-передачи.
-   Очистите каталог от результатов проведения экспериментов:
    ```shell
    make clean
    ```
