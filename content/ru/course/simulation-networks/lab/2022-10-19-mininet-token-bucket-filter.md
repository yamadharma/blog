---
title: "Mininet. Token Bucket Filter"
author: ["Dmitry S. Kulyabov"]
date: 2022-10-19T19:51:00+03:00
lastmod: 2023-10-12T20:25:00+03:00
tags: ["network"]
categories: ["computer-science", "science"]
draft: false
weight: 205
toc: true
type: "book"
feedback: false
slug: "mininet-token-bucket-filter"
summary: "Управление пропускной способностью с помощью дисциплина очередей Token Bucket Filter (TBF)"
linktitle: "Token Bucket Filter"
menu:
  "mininet-token-bucket-filter":
    parent: "simulation-networks-lab"
    weight: 205
    identifier: "mininet-token-bucket-filter"
---

Управление пропускной способностью с помощью дисциплина очередей Token Bucket Filter (TBF).

<!--more-->


## <span class="section-num">1</span> Общая информация {#общая-информация}


### <span class="section-num">1.1</span> Цели {#цели}

-   Освоить использование дисциплины очередей Token Bucket Filter (TBF).


### <span class="section-num">1.2</span> Задачи {#задачи}

-   Получить понятие об алгоритме Token Bucket.
-   Использовать Token Bucket Filter (tbf) в Linux.
-   Понять, как комбинировать дисциплины очередей в Linux Traffic Control (tc).
-   Объединить tbf и NETEM.
-   Эмулируйте свойства WAN в Mininet.


### <span class="section-num">1.3</span> Видео: Token Bucket Filter. Введение {#видео-token-bucket-filter-dot-введение}

{{< tabs tabTotal="2" >}}
{{< rtab tabName="RuTube" >}}

{{< rutube 844474172fbad39a5f8a7ffc8a927a44 >}}

{{< /rtab >}}
{{< rtab tabName="Youtube" >}}

{{< youtube 9mqs0aw4tQE >}}

{{< /rtab >}}
{{< /tabs >}}


## <span class="section-num">2</span> Теоретические сведения {#теоретические-сведения}


### <span class="section-num">2.1</span> Введение в алгоритм Token Bucket {#введение-в-алгоритм-token-bucket}

-   При моделировании глобальной сети (WAN) иногда необходимо ограничить пропускную способность устройств (конечных хостов и сетевых устройств), чтобы наблюдать за поведением сети в различных условиях.
-   Token Bucket --- это алгоритм, используемый в сетях с коммутацией пакетов для ограничения пропускной способности и пиковой нагрузки трафика.
-   Сущность Token Bucket состоит в добавлении токенов (представленных в виде пакетов или байтов) с фиксированной скоростью в буфер (_ведро_) с фиксированной ёмкостью.
-   Когда приходит новый пакет длиной \\(n\\) байт, буфер (ведро) проверяется на количество доступных токенов; если доступно хотя бы \\(n\\) токенов, \\(n\\) токенов удаляются из ведра, и пакет отправляется в сеть.
-   В противном случае токены не удаляются, и пакет считается несоответствующим. В таком случае пакет может быть отброшен, поставлен в очередь или передан, но помечен как несоответствующий.
-   Параметры алгоритма:
    -   `rate` есть скорость передачи; она определяется частотой, с которой токены добавляются в корзину.
    -   _Burstiness_ (всплеск):  когда ведро полностью занято (т. е. никакие пакеты не потребляют токены), новые пакеты будут потреблять токены сразу, без ограничений. Всплеск определяется как количество токенов, которые могут поместиться в ведро (или размер ведра).
    -   Иногда создаётся ещё одно маленькое ведро, с размером, равным максимально передаваемому элементу (Maximum Transmission Unit --- MTU). Скорость обработки этого буфера намного превышает исходную (peak rate --- пиковая скорость).


### <span class="section-num">2.2</span> Основной синтаксис tbf {#основной-синтаксис-tbf}

-   Основной синтаксис `tbf`, используемый с `tc`, следующий:
    ```shell
    tc qdisc [add | ...] dev [dev_id] root tbf limit [BYTES] burst [BYTES] rate [BPS] [mtu BYTES] [ peakrate BPS ] [ latency TIME ]
    ```
-   Здесь:
    -   `tc` : инструмент управления трафиком Linux;
    -   `qdisc` : дисциплина очереди (qdisc) представляет собой набор правил, определяющих порядок, в котором обслуживаются пакеты, поступающие с выходных данных IP-протокола. Дисциплина очереди применяется к очереди пакетов, чтобы решить, когда отправлять каждый пакет;
    -   `[add | del | replace | change | show]` : операция над `qdisc`;
    -   `dev [dev_id]`: задаёт интерфейс;
    -   `tbf` : указывает, что используется алгоритм _Token Bucket Filter_;
    -   `limit [BYTES]` : размер очереди пакетов в байтах;
    -   `burst [BYTES]` : количество байтов, которое может поместиться в корзину;
    -   `rate [BPS]`: скорость передачи, определяемая частотой, с которой токены добавляются в корзину;
    -   `mtu [BYTES]` : максимальная единица передачи в байтах;
    -   `peakrate [BPS]` (пиковая скорость [бит/с]): максимальная скорость пакета;
    -   `latency [TIME]` : максимальное время ожидания пакета в очереди.


## <span class="section-num">3</span> Подготовка стенда {#подготовка-стенда}


### <span class="section-num">3.1</span> Лабораторная топология {#лабораторная-топология}

-   В топологии используется сеть 10.0.0.0/8, назначенная Mininet по умолчанию.
-   Топология представляет собой коммутатор с двумя подключёнными к нему хостами.
-   Для запуска топологии (рис. [1](#figure--fig:tbf:topology)) используем параметры командной строки:
    ```shell
    sudo mn --topo=linear,2 -x
    ```
    <a id="figure--fig:tbf:topology"></a>

    <figure>
    <?xml version="1.0" encoding="us-ascii" standalone="no"?><svg
    xmlns="http://www.w3.org/2000/svg"
    xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css"
    height="120px" preserveAspectRatio="none"
    style="width:690px;height:120px;background:#FFFFFF;" version="1.1"
    viewBox="0 0 690 120" width="690px"
    zoomAndPan="magnify"><defs/><g><g
    id="elem_h1"><polygon fill="#F1F1F1"
    points="9.5,7,9.5,7.2102,19.5,6.5857,29.5,7.1933,39.5,7.3997,49.5,6.2866,59.5,6.9223,69.5,7,69.4456,6.8687,69.8046,7.0283,70.1984,7.2719,70.4725,7.2264,70.9848,7.7563,71.2678,7.7322,71.0737,7.6518,71.3533,8.0606,71.6937,8.4944,71.6807,8.782,71.8746,9.1552,72,9.5,71.9681,9.5,72.1785,19.7318,72.2391,29.9635,72.5857,40.1953,72.6711,50.427,72.6793,60.6588,72.2546,70.8905,72.4636,81.1223,72.7022,91.354,71.2788,101.5858,72,111.8175,72.209,111.9041,71.7622,112.1332,71.8715,112.5927,71.4082,112.815,71.3931,113.223,71.2678,113.5853,71.3624,113.8137,70.908,113.7167,70.5741,113.9106,70.2503,114.1289,69.9066,114.2992,69.5,114.3175,69.5,114.3136,59.5,114.6047,49.5,113.7451,39.5,114.6019,29.5,114.8657,19.5,114.762,9.5,114.3175,9.5782,114.5063,9.0848,114.0223,8.7097,113.8238,8.3601,113.6868,8.0783,113.7136,7.7322,113.5853,7.6717,113.5602,7.7956,113.3186,7.3855,112.8559,7.1872,112.4809,7.2167,112.2002,7,111.8175,6.3332,111.8175,6.4809,101.5858,7.649,91.354,7.4357,81.1223,7.7345,70.8905,6.6782,60.6588,7.3192,50.427,7.5904,40.1953,6.5276,29.9635,6.9041,19.7318,7,9.5,7.0388,9.5161,7.3472,9.2296,7.2916,8.7924,7.5818,8.4983,7.4152,8.0151,7.7322,7.7322,7.6458,7.5237,8.15,7.7409,8.3479,7.2186,8.8578,7.4496,9.1728,7.2101,9.5,7"
    style="stroke:#181818;stroke-width:0.5;"/><image height="48"
    width="45" x="17"
    xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAC0AAAAwCAIAAAAKMGSIAAABYUlEQVR4Xu2Y7Y3DIAyGu2JGyAgZ4UbICBmBEW4ERugI3eCsvEAxifnwWbqexPMrjfHLE0olmsfrM3iUN/6I4OG937ZtGYe6qJdFqggeOglAvSxSRfAoswdhkSqmB+fGw/eRt7BIFTcerC6jaKlw46GARaqYHpzpwZkenH/lse/7dxWeqaHt4S2OF00aHsdxUJWeuCwYQSvd5VGvmoCvdcBjtwaxzrkxD1wbgtjpEUHs9IggdnpEEDs9IogVPb4y8mrotgOxokc2MiDd/yWIFT0+ZT1y8iquDUHs9IggVvTIRgZwn85mzhTEOsnjmXGtmiN65GBQcjcn/SQbHsu5PBhTp2w76ex99Xgs584o3wZlIOH2jWOcpU2XxxUyo3M2SaQnphUuxqzr+p6nRfBIe7iHYrXpoxM2EB3K04LVCR6j0MTrSTmzDA1Ou/KK0uN2N/Qg7VylB76LUSr/yJUe5vwAo6Ho0KlFbyoAAAAASUVORK5CYII="
    y="17"/><text fill="#000000" font-family="xkcd Script" font-size="14"
    lengthAdjust="spacing" textLength="10" x="36.5"
    y="80.2429">h1</text><text fill="#000000" font-family="xkcd Script"
    font-size="14" lengthAdjust="spacing" textLength="39" x="20"
    y="99.9017">10.0.0.1</text></g><g
    id="elem_h2"><polygon fill="#F1F1F1"
    points="621.5,7,621.5,7.2102,631.5,6.5857,641.5,7.1933,651.5,7.3997,661.5,6.2866,671.5,6.9223,681.5,7,681.4456,6.8687,681.8046,7.0283,682.1984,7.2719,682.4725,7.2264,682.9848,7.7563,683.2678,7.7322,683.0737,7.6518,683.3533,8.0606,683.6937,8.4944,683.6807,8.782,683.8746,9.1552,684,9.5,683.9681,9.5,684.1785,19.7318,684.2391,29.9635,684.5857,40.1953,684.6711,50.427,684.6793,60.6588,684.2546,70.8905,684.4636,81.1223,684.7022,91.354,683.2788,101.5858,684,111.8175,684.209,111.9041,683.7622,112.1332,683.8715,112.5927,683.4082,112.815,683.3931,113.223,683.2678,113.5853,683.3624,113.8137,682.908,113.7167,682.5741,113.9106,682.2503,114.1289,681.9066,114.2992,681.5,114.3175,681.5,114.3136,671.5,114.6047,661.5,113.7451,651.5,114.6019,641.5,114.8657,631.5,114.762,621.5,114.3175,621.5782,114.5063,621.0848,114.0223,620.7097,113.8238,620.3601,113.6868,620.0783,113.7136,619.7322,113.5853,619.6717,113.5602,619.7956,113.3186,619.3855,112.8559,619.1872,112.4809,619.2167,112.2002,619,111.8175,618.3332,111.8175,618.4809,101.5858,619.649,91.354,619.4357,81.1223,619.7345,70.8905,618.6782,60.6588,619.3192,50.427,619.5904,40.1953,618.5276,29.9635,618.9041,19.7318,619,9.5,619.0388,9.5161,619.3472,9.2296,619.2916,8.7924,619.5818,8.4983,619.4152,8.0151,619.7322,7.7322,619.6458,7.5237,620.15,7.7409,620.3479,7.2186,620.8578,7.4496,621.1728,7.2101,621.5,7"
    style="stroke:#181818;stroke-width:0.5;"/><image height="48"
    width="45" x="629"
    xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAC0AAAAwCAIAAAAKMGSIAAABYUlEQVR4Xu2Y7Y3DIAyGu2JGyAgZ4UbICBmBEW4ERugI3eCsvEAxifnwWbqexPMrjfHLE0olmsfrM3iUN/6I4OG937ZtGYe6qJdFqggeOglAvSxSRfAoswdhkSqmB+fGw/eRt7BIFTcerC6jaKlw46GARaqYHpzpwZkenH/lse/7dxWeqaHt4S2OF00aHsdxUJWeuCwYQSvd5VGvmoCvdcBjtwaxzrkxD1wbgtjpEUHs9IggdnpEEDs9IogVPb4y8mrotgOxokc2MiDd/yWIFT0+ZT1y8iquDUHs9IggVvTIRgZwn85mzhTEOsnjmXGtmiN65GBQcjcn/SQbHsu5PBhTp2w76ex99Xgs584o3wZlIOH2jWOcpU2XxxUyo3M2SaQnphUuxqzr+p6nRfBIe7iHYrXpoxM2EB3K04LVCR6j0MTrSTmzDA1Ou/KK0uN2N/Qg7VylB76LUSr/yJUe5vwAo6Ho0KlFbyoAAAAASUVORK5CYII="
    y="17"/><text fill="#000000" font-family="xkcd Script" font-size="14"
    lengthAdjust="spacing" textLength="15" x="646"
    y="80.2429">h2</text><text fill="#000000" font-family="xkcd Script"
    font-size="14" lengthAdjust="spacing" textLength="44" x="629.5"
    y="99.9017">10.0.0.2</text></g><g
    id="elem_s1"><polygon fill="#F1F1F1"
    points="197.5,31.83,197.5,32.0402,208,31.4157,218.5,32.0233,229,32.2297,239.5,31.1166,250,31.7523,260.5,31.83,260.4456,31.6987,260.8046,31.8583,261.1984,32.1019,261.4725,32.0564,261.9848,32.5863,262.2678,32.5622,262.0737,32.4818,262.3533,32.8906,262.6937,33.3244,262.6807,33.612,262.8746,33.9852,263,34.33,262.9681,34.33,263.1785,44.8618,263.2391,55.3935,263.5857,65.9253,263.6711,76.457,263,86.9888,263.2092,87.0754,262.932,87.3748,262.8499,87.755,262.7769,88.139,262.1921,88.311,262.2678,88.7565,262.3543,88.9655,261.8764,88.8117,261.6288,89.2138,261.144,89.0434,260.8448,89.3212,260.5,89.4888,260.5,90.2304,250,89.44,239.5,89.5941,229,89.8274,218.5,89.905,208,89.4849,197.5,89.4888,197.5366,89.5772,197.0734,89.166,196.8292,89.2834,196.5093,89.2182,196.1425,89.0399,195.7322,88.7565,195.921,88.8347,195.437,88.3413,195.2385,87.9662,195.1015,87.6166,195.1283,87.3348,195,86.9888,194.8035,86.9888,195.6814,76.457,194.8253,65.9253,194.6569,55.3935,195.2283,44.8618,195,34.33,194.7946,34.2449,194.9866,33.9102,195.4927,33.7057,195.5735,33.3249,195.812,33.0095,195.7322,32.5622,195.6912,32.4631,196.1265,32.5141,196.5147,32.4512,196.7326,31.9774,197.1342,31.9469,197.5,31.83"
    style="stroke:#181818;stroke-width:0.5;"/><image height="18"
    width="48" x="205"
    xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAASCAIAAACSBMrtAAAA4klEQVR4Xs2WYRHDIAyFa7ESKgEJSEACEpCABCQgAQfLJXcQMtig20G/n6958JpQrkd6GIcUdlMCWWvPTSilQghVIGOMrFpOjLEE4tJ6qB3UpCoQqyl476WEBESqyKzFOQe7k+tLICptrvJ3y1AgGCLUNUfZe90blqFAsCKJmfwIPgqua61vW4hfAwkdNpu1XNeVH6XBQAnPJifr0Hau8+lw3Y9Z0nighBucnesAGiM6T5CleVZ6lolAsG4vECwN94dUP1oMItWpQGvoBuJjXgnd1P490F6qQDLzDujYPe5/6AU/4JUKUwnC3AAAAABJRU5ErkJggg=="
    y="41.83"/><text fill="#000000" font-family="xkcd Script"
    font-size="14" lengthAdjust="spacing" textLength="9" x="226.5"
    y="75.0729">s1</text></g><g id="elem_s2"><polygon
    fill="#F1F1F1"
    points="430.5,31.83,430.5,32.0402,441,31.4157,451.5,32.0233,462,32.2297,472.5,31.1166,483,31.7523,493.5,31.83,493.4456,31.6987,493.8046,31.8583,494.1984,32.1019,494.4725,32.0564,494.9848,32.5863,495.2678,32.5622,495.0737,32.4818,495.3533,32.8906,495.6937,33.3244,495.6807,33.612,495.8746,33.9852,496,34.33,495.9681,34.33,496.1785,44.8618,496.2391,55.3935,496.5857,65.9253,496.6711,76.457,496,86.9888,496.2092,87.0754,495.932,87.3748,495.8499,87.755,495.7769,88.139,495.1921,88.311,495.2678,88.7565,495.3543,88.9655,494.8764,88.8117,494.6288,89.2138,494.144,89.0434,493.8448,89.3212,493.5,89.4888,493.5,90.2304,483,89.44,472.5,89.5941,462,89.8274,451.5,89.905,441,89.4849,430.5,89.4888,430.5366,89.5772,430.0734,89.166,429.8292,89.2834,429.5093,89.2182,429.1425,89.0399,428.7322,88.7565,428.921,88.8347,428.437,88.3413,428.2385,87.9662,428.1015,87.6166,428.1283,87.3348,428,86.9888,427.8035,86.9888,428.6814,76.457,427.8253,65.9253,427.6569,55.3935,428.2283,44.8618,428,34.33,427.7946,34.2449,427.9866,33.9102,428.4927,33.7057,428.5735,33.3249,428.812,33.0095,428.7322,32.5622,428.6912,32.4631,429.1265,32.5141,429.5147,32.4512,429.7326,31.9774,430.1342,31.9469,430.5,31.83"
    style="stroke:#181818;stroke-width:0.5;"/><image height="18"
    width="48" x="438"
    xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAASCAIAAACSBMrtAAAA4klEQVR4Xs2WYRHDIAyFa7ESKgEJSEACEpCABCQgAQfLJXcQMtig20G/n6958JpQrkd6GIcUdlMCWWvPTSilQghVIGOMrFpOjLEE4tJ6qB3UpCoQqyl476WEBESqyKzFOQe7k+tLICptrvJ3y1AgGCLUNUfZe90blqFAsCKJmfwIPgqua61vW4hfAwkdNpu1XNeVH6XBQAnPJifr0Hau8+lw3Y9Z0nighBucnesAGiM6T5CleVZ6lolAsG4vECwN94dUP1oMItWpQGvoBuJjXgnd1P490F6qQDLzDujYPe5/6AU/4JUKUwnC3AAAAABJRU5ErkJggg=="
    y="41.83"/><text fill="#000000" font-family="xkcd Script"
    font-size="14" lengthAdjust="spacing" textLength="14" x="457"
    y="75.0729">s2</text></g><g id="link_h1_s1"><path
    d="M72.31,60.66 L72.31,60.9402 L82.515,60.1076 L92.72,60.9177
    L102.925,61.1929 L113.13,59.7088 L123.335,60.5564 L133.54,60.0913
    L143.745,60.1487 L153.95,60.5691 L164.155,59.7382 L174.36,61.3982
    L184.565,59.8196 L194.77,60.66 " fill="none"
    style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000"
    font-family="xkcd Script" font-size="13" lengthAdjust="spacing"
    textLength="43" x="79.9473" y="76.098">h1-eth0</text><text
    fill="#000000" font-family="xkcd Script" font-size="13"
    lengthAdjust="spacing" textLength="38" x="148.9518"
    y="76.155">s1-eth1</text></g><g
    id="link_s1_s2"><path d="M263.1,60.66 L263.1,60.9402 L273.3806,60.1076
    L283.6613,60.9177 L293.9419,61.1929 L304.2225,59.7088
    L314.5031,60.5564 L324.7838,60.0913 L335.0644,60.1487 L345.345,60.5691
    L355.6256,59.7382 L365.9063,61.3982 L376.1869,59.8196
    L386.4675,60.3963 L396.7481,61.2359 L407.0287,60.5456 L417.3094,60.751
    L427.59,60.66 " fill="none"
    style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000"
    font-family="xkcd Script" font-size="13" lengthAdjust="spacing"
    textLength="41" x="325" y="55.8143">10 Gbps</text><text fill="#000000"
    font-family="xkcd Script" font-size="13" lengthAdjust="spacing"
    textLength="42" x="270.8484" y="76.0979">s1-eth2</text><text
    fill="#000000" font-family="xkcd Script" font-size="13"
    lengthAdjust="spacing" textLength="46" x="373.8755"
    y="76.0409">s2-eth2</text></g><g
    id="link_s2_h2"><path d="M496.09,60.66 L496.09,60.9402
    L506.3058,60.1076 L516.5217,60.9177 L526.7375,61.1929
    L536.9533,59.7088 L547.1692,60.5564 L557.385,60.0913 L567.6008,60.1487
    L577.8167,60.5691 L588.0325,59.7382 L598.2483,61.3982
    L608.4642,59.8196 L618.68,60.66 " fill="none"
    style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000"
    font-family="xkcd Script" font-size="13" lengthAdjust="spacing"
    textLength="42" x="503.837" y="76.0979">s2-eth1</text><text
    fill="#000000" font-family="xkcd Script" font-size="13"
    lengthAdjust="spacing" textLength="47" x="564.112"
    y="76.041">h2-eth0</text></g></g></svg>
    <figcaption>

      <span class="figure-number">&#1056;&#1080;&#1089;. 1.: </span>Лабораторная топология
    </figcaption>
    </figure>


### <span class="section-num">3.2</span> Рабочие файлы {#рабочие-файлы}

-   Подключимся к виртуальной машине:
    ```shell
    ssh -Y mininet@192.168.x.y
    ```
-   Для рабочих файлов будем использовать каталог `~/work/lab_tbf`:
    ```shell
    mkdir -p ~/work/lab_tbf
    ```


## <span class="section-num">4</span> Интерактивный эксперимент {#интерактивный-эксперимент}


### <span class="section-num">4.1</span> Отсутствие ограничения скорости {#отсутствие-ограничения-скорости}

-   Запустим iPerf3 в режиме сервера, выполните команду `iperf3 -s` в терминале хоста `h2`:
    ```shell
    iperf3 -s
    ```
-   Запустим iPerf3 в клиентском режиме, запустите команду `iperf3 -c 10.0.0.2` для хоста `h1`:
    ```shell
    iperf3 -c 10.0.0.2
    ```
-   Чтобы остановить сервер, нажмите `Ctrl+c` в терминале хоста `h2`.


### <span class="section-num">4.2</span> Ограничение скорости на конечных хостах {#ограничение-скорости-на-конечных-хостах}

-   Команду `tc` можно применить к сетевому интерфейсу устройства для формирования исходящего трафика.
-   Будем ограничивать скорость отправки конечного хоста с помощью фильтра Token Bucket Filter (tbf), который является реализацией алгоритма Token Bucket.


#### <span class="section-num">4.2.1</span> Определим интерфейс хостов `h1` и `h2` {#определим-интерфейс-хостов-h1-и-h2}

-   На хосте `h1` введите команду `ifconfig`, чтобы отобразить информацию, относящуюся к его сетевым интерфейсам и назначенным им IP-адресам.
    -   Хост `h1` имеет два интерфейса: `h1-eth0` и `lo`. Интерфейс `h1-eth0` на хосте `h1` настроен с IP-адресом 10.0.0.1 и маской подсети 255.0.0.0. Этот интерфейс необходимо использовать в `tc` при эмуляции сети.
-   В командной строке хоста `h2` также введите команду `ifconfig`.
    -   Хост `h2` имеет два интерфейса: `h2-eth0` и `lo`. Интерфейс `h2-eth0` на хосте `h1` настроен с IP-адресом 10.0.0.2 и маской подсети 255.0.0.0. Этот интерфейс необходимо использовать в `tc` при эмуляции сети.


#### <span class="section-num">4.2.2</span> Эмуляция глобальной сети 10 Гбит/с с высокой задержкой {#эмуляция-глобальной-сети-10-гбит-с-с-высокой-задержкой}

-   Будем использовать команду `tbf` на сетевом интерфейсе для управления скоростью исходящего трафика.
-   Измените пропускную способность хоста `h1`:
    ```shell
    sudo tc qdisc add dev h1-eth0 root tbf rate 10gbit burst 5000000 limit 15000000
    ```
-   Эта команда устанавливает пропускную способность на 10 Гбит/с на интерфейсе `h1-eth0` хоста `h1`.
-   Параметры Token Bucket Filter:
    -   rate : 10gbit;
    -   burst : 5,000,000;
    -   limit : 15,000,000.
-   Распишем элементы команды:
    -   `sudo` : включить выполнение команды с более высокими привилегиями безопасности;
    -   `tc` : вызвать управление трафиком Linux;
    -   `qdisc` : изменить дисциплину очередей сетевого планировщика;
    -   `add` (добавить): создать новое правило;
    -   `dev h1-eth0 root` : интерфейс, на котором будет применяться правило;
    -   `tbf` : использовать алгоритм Token Bucket Filter;
    -   `rate` : укажите скорость передачи (10 Гбит/с);
    -   `burst` : количество байтов, которое может поместиться в корзину (5 000 000) за один такт;
    -   `limit` : размер очереди в байтах (15 000 000).
-   Расчёт всплеска.
    -   `tbf` требует установки значения всплеска при ограничении скорости. Это значение должно быть достаточно высоким, чтобы обеспечить установленную вами скорость.
    -   Она должна быть не ниже указанной частоты, делённой на HZ, где HZ --- тактовая частота, настроенная как параметр ядра, и может быть извлечена с помощью следующей команды:
        ```shell
        egrep '^CONFIG_HZ_[0-9]+' /boot/config-`uname -r`
        ```
    -   HZ на `h1` --- 250. Таким образом, для расчёта всплеска делим 10 Гбит/с на 250:
        -   10 Gbps = 10,000,000,000 bps;
        -   burst = 10,000,000,000 [bps]/250 [s<sup>-1</sup>]  = 40,000,000 [bit] = 40,000,000/8 [byte] = 5,000,000 [byte].
    -   Полученное значение должно использоваться в команде в качестве значения _burst_ (всплеска).
-   Проверим конфигурацию с помощью инструмента `iperf3` для измерения пропускной способности.
-   Запустим iPerf3 в режиме сервера, выполните команду `iperf3 -s` в терминале хоста `h2`:
    ```shell
    iperf3 -s
    ```
-   Запустим iPerf3 в клиентском режиме, запустите команду `iperf3 -c 10.0.0.2` для хоста `h1`:
    ```shell
    iperf3 -c 10.0.0.2
    ```
-   Чтобы остановить сервер, нажмите `Ctrl+c` в терминале хоста `h2`.
-   Удалите конфигурацию на хосте `h1`:
    ```shell
    sudo tc qdisc del dev h1-eth0 root
    ```


### <span class="section-num">4.3</span> Ограничение скорости на коммутаторах {#ограничение-скорости-на-коммутаторах}

-   Применим Token Bucket Filter к интерфейсам коммутатора.
-   При ограничении скорости на интерфейсе `s1-eth2` коммутатора `s1` все сеансы связи между коммутатором `s1` и коммутатором `s2` будут фильтроваться в соответствии с применяемыми правилами.
-   Введите в терминале `s1` команду `ifconfig`, чтобы отобразить информацию, связанную с его сетевыми интерфейсами:
    -   `s1-eth1` : интерфейс, соединяющий коммутатор `s1` с хостом `h1`;
    -   `s1-eth2` : интерфейс, соединяющий коммутатор `s1` с коммутатором `s2`;
    -   `s2-eth1` : интерфейс, соединяющий коммутатор `s2` с хостом `h2`;
    -   `s2-eth2` : интерфейс, соединяющий коммутатор `s2` с коммутатором `s1`.
-   Примените правило ограничения скорости `tbf` к интерфейсу коммутатора `s1`, который соединяет его с коммутатором `s2` (`s1-eth2`):
    ```shell
    sudo tc qdisc add dev s1-eth2 root tbf rate 10gbit burst 5000000 limit 15000000
    ```

    -   Параметры Token Bucket Filter следующие:
        -   `rate` : 10gbit;
        -   `burst` : 5,000,000;
        -   `limit` : 15,000,000.
-   Проверим конфигурацию с помощью инструмента `iperf3` для измерения пропускной способности.
-   Запустим iPerf3 в режиме сервера, выполните команду `iperf3 -s` в терминале хоста `h2`:
    ```shell
    iperf3 -s
    ```
-   Запустим iPerf3 в клиентском режиме, запустите команду `iperf3 -c 10.0.0.2` для хоста `h1`:
    ```shell
    iperf3 -c 10.0.0.2
    ```
-   Чтобы остановить сервер, нажмите `Ctrl+c` в терминале хоста `h2`.
-   Удалите конфигурацию на коммутаторе `s1`:
    ```shell
    sudo tc qdisc del dev s1-eth2 root
    ```


### <span class="section-num">4.4</span> Объединение NETEM и TBF {#объединение-netem-и-tbf}

-   NETEM используется для введения задержки, джиттера, повреждения пакетов и т. д.
-   TBF может использоваться для ограничения скорости.
-   Возможно комбинировать несколько модулей.
-   Первый `qdisc` (`qdisc1`) присоединён к корневой метке. Затем последующие `qdisc` можно прикрепить к своим родителям, указав правильную метку.
-   Объединим NETEM и TBF, чтобы сделать эмуляцию адекватней. Введём задержку, джиттер и повреждение пакетов, указав скорость на интерфейсе коммутатора `s1`.
-   Введём в терминале коммутатора `s1`:
    ```shell
    sudo tc qdisc add dev s1-eth2 root handle 1: netem delay 10ms
    ```

    -   Ключевое слово `handle` задаёт дескриптор подключения, имеющий смысл очерёдности подключения разных дисциплин `qdisc`.
-   Теперь можно убедиться, что соединение от хоста `h1` к хосту `h2` имеет заданную задержку.
-   Запустите команду `ping` с терминала хоста `h1`:
    ```shell
    ping 10.0.0.2
    ```
-   Нажмите `Ctrl+c`, чтобы остановить тест.
-   Добавим второе правило на коммутаторе `s1`, которое задаёт ограничение скорости с помощью `tbf`:
    ```shell
    sudo tc qdisc add dev s1-eth2 parent 1: handle 2: tbf rate 2gbit burst 1000000 limit 2000000
    ```

    -   Параметры Token Bucket Filter следующие:
        -   `rate` : 2gbit;
        -   `burst` : 1,000,000;
        -   `limit` : 2,000,000.
-   Проверим предыдущую конфигурацию с помощью инструмента iperf3 для измерения пропускной способности.
-   Запустим iPerf3 в режиме сервера, выполните команду `iperf3 -s` в терминале хоста `h2`:
    ```shell
    iperf3 -s
    ```
-   Запустим iPerf3 в клиентском режиме, запустите команду `iperf3 -c 10.0.0.2` для хоста `h1`:
    ```shell
    iperf3 -c 10.0.0.2
    ```
-   Чтобы остановить сервер, нажмите `Ctrl+c` в терминале хоста `h2`.
-   Удалите конфигурацию на коммутаторе `s1`:
    ```shell
    sudo tc qdisc del dev s1-eth2 root
    ```


### <span class="section-num">4.5</span> Видео: Token Bucket Filter. Интерактивный эксперимент {#видео-token-bucket-filter-dot-интерактивный-эксперимент}

{{< tabs tabTotal="2" >}}
{{< rtab tabName="RuTube" >}}

{{< rutube 273ce5d8455a3ba7c18e99a0ce03ced4 >}}

{{< /rtab >}}
{{< rtab tabName="Youtube" >}}

{{< youtube ncCPgMUdgjM >}}

{{< /rtab >}}
{{< /tabs >}}
