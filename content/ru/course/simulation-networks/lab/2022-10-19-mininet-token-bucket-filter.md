---
title: "Mininet. Token Bucket Filter"
author: ["Dmitry S. Kulyabov"]
date: 2022-10-19T19:51:00+03:00
lastmod: 2022-11-25T16:53:00+03:00
draft: false
weight: 205
toc: true
type: "book"
feedback: false
slug: "mininet-token-bucket-filter"
summary: "Управление пропускной способностью с помощью дисциплина очередей Token Bucket Filter (TBF)"
linktitle: "Token Bucket Filter"
menu:
  "mininet-token-bucket-filter":
    parent: "simulation-networks-lab"
    weight: 205
    identifier: "mininet-token-bucket-filter"
---

Управление пропускной способностью с помощью дисциплина очередей Token Bucket Filter (TBF).

<!--more-->


## <span class="section-num">1</span> Общая информация {#общая-информация}


### <span class="section-num">1.1</span> Цели {#цели}

-   Освоить использование дисциплины очередей Token Bucket Filter (TBF).


### <span class="section-num">1.2</span> Задачи {#задачи}

-   Получить понятие об алгоритме Token Bucket.
-   Использовать Token Bucket Filter (tbf) в Linux.
-   Понять, как комбинировать дисциплины очередей в Linux Traffic Control (tc).
-   Объединить tbf и NETEM.
-   Эмулируйте свойства WAN в Mininet.


### <span class="section-num">1.3</span> Видео: Token Bucket Filter. Введение {#видео-token-bucket-filter-dot-введение}

{{< tabs tabTotal="2" >}}
{{< rtab tabName="RuTube" >}}

{{< rutube 844474172fbad39a5f8a7ffc8a927a44 >}}

{{< /rtab >}}
{{< rtab tabName="Youtube" >}}

{{< youtube 9mqs0aw4tQE >}}

{{< /rtab >}}
{{< /tabs >}}


## <span class="section-num">2</span> Теоретические сведения {#теоретические-сведения}


### <span class="section-num">2.1</span> Введение в алгоритм Token Bucket {#введение-в-алгоритм-token-bucket}

-   При моделировании глобальной сети (WAN) иногда необходимо ограничить пропускную способность устройств (конечных хостов и сетевых устройств), чтобы наблюдать за поведением сети в различных условиях.
-   Token Bucket --- это алгоритм, используемый в сетях с коммутацией пакетов для ограничения пропускной способности и пиковой нагрузки трафика.
-   Сущность Token Bucket состоит в добавлении токенов (представленных в виде пакетов или байтов) с фиксированной скоростью в буфер (_ведро_) с фиксированной ёмкостью.
-   Когда приходит новый пакет длиной \\(n\\) байт, буфер (ведро) проверяется на количество доступных токенов; если доступно хотя бы \\(n\\) токенов, \\(n\\) токенов удаляются из ведра, и пакет отправляется в сеть.
-   В противном случае токены не удаляются, и пакет считается несоответствующим. В таком случае пакет может быть отброшен, поставлен в очередь или передан, но помечен как несоответствующий.
-   Параметры алгоритма:
    -   `rate` есть скорость передачи; она определяется частотой, с которой токены добавляются в корзину.
    -   _Burstiness_ (всплеск):  когда ведро полностью занято (т. е. никакие пакеты не потребляют токены), новые пакеты будут потреблять токены сразу, без ограничений. Всплеск определяется как количество токенов, которые могут поместиться в ведро (или размер ведра).
    -   Иногда создаётся ещё одно маленькое ведро, с размером, равным максимально передаваемому элементу (Maximum Transmission Unit --- MTU). Скорость обработки этого буфера намного превышает исходную (peak rate --- пиковая скорость).


### <span class="section-num">2.2</span> Основной синтаксис tbf {#основной-синтаксис-tbf}

-   Основной синтаксис `tbf`, используемый с `tc`, следующий:
    ```shell
    tc qdisc [add | ...] dev [dev_id] root tbf limit [BYTES] burst [BYTES] rate [BPS] [mtu BYTES] [ peakrate BPS ] [ latency TIME ]
    ```
-   Здесь:
    -   `tc` : инструмент управления трафиком Linux;
    -   `qdisc` : дисциплина очереди (qdisc) представляет собой набор правил, определяющих порядок, в котором обслуживаются пакеты, поступающие с выходных данных IP-протокола. Дисциплина очереди применяется к очереди пакетов, чтобы решить, когда отправлять каждый пакет;
    -   `[add | del | replace | change | show]` : операция над `qdisc`;
    -   `dev [dev_id]`: задаёт интерфейс;
    -   `tbf` : указывает, что используется алгоритм _Token Bucket Filter_;
    -   `limit [BYTES]` : размер очереди пакетов в байтах;
    -   `burst [BYTES]` : количество байтов, которое может поместиться в корзину;
    -   `rate [BPS]`: скорость передачи, определяемая частотой, с которой токены добавляются в корзину;
    -   `mtu [BYTES]` : максимальная единица передачи в байтах;
    -   `peakrate [BPS]` (пиковая скорость [бит/с]): максимальная скорость пакета;
    -   `latency [TIME]` : максимальное время ожидания пакета в очереди.


## <span class="section-num">3</span> Подготовка стенда {#подготовка-стенда}


### <span class="section-num">3.1</span> Лабораторная топология {#лабораторная-топология}

-   В топологии используется сеть 10.0.0.0/8, назначенная Mininet по умолчанию.
-   Топология представляет собой коммутатор с двумя подключёнными к нему хостами.
-   Для запуска топологии (рис. [1](#figure--fig:tbf:topology)) используем параметры командной строки:
    ```shell
    sudo mn --topo=linear,2 -x
    ```
    <a id="figure--fig:tbf:topology"></a>

    <figure>
    <svg
    xmlns="http://www.w3.org/2000/svg"
    xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css"
    height="120px" preserveAspectRatio="none"
    style="width:690px;height:120px;background:#FFFFFF;" version="1.1"
    viewBox="0 0 690 120" width="690px"
    zoomAndPan="magnify"><defs/><g><g id="elem_h1"><polygon fill="#F1F1F1"
    points="9.5,7,9.5,7.2102,19.5,6.5857,29.5,7.1933,39.5,7.3997,49.5,6.2866,59.5,6.9223,69.5,7,69.4456,6.8687,69.8046,7.0283,70.1984,7.2719,70.4725,7.2264,70.9848,7.7563,71.2678,7.7322,71.0737,7.6518,71.3533,8.0606,71.6937,8.4944,71.6807,8.782,71.8746,9.1552,72,9.5,71.9681,9.5,72.1785,19.7318,72.2391,29.9635,72.5857,40.1953,72.6711,50.427,72.6793,60.6588,72.2546,70.8905,72.4636,81.1223,72.7022,91.354,71.2788,101.5858,72,111.8175,72.209,111.9041,71.7622,112.1332,71.8715,112.5927,71.4082,112.815,71.3931,113.223,71.2678,113.5853,71.3624,113.8137,70.908,113.7167,70.5741,113.9106,70.2503,114.1289,69.9066,114.2992,69.5,114.3175,69.5,114.3136,59.5,114.6047,49.5,113.7451,39.5,114.6019,29.5,114.8657,19.5,114.762,9.5,114.3175,9.5782,114.5063,9.0848,114.0223,8.7097,113.8238,8.3601,113.6868,8.0783,113.7136,7.7322,113.5853,7.6717,113.5602,7.7956,113.3186,7.3855,112.8559,7.1872,112.4809,7.2167,112.2002,7,111.8175,6.3332,111.8175,6.4809,101.5858,7.649,91.354,7.4357,81.1223,7.7345,70.8905,6.6782,60.6588,7.3192,50.427,7.5904,40.1953,6.5276,29.9635,6.9041,19.7318,7,9.5,7.0388,9.5161,7.3472,9.2296,7.2916,8.7924,7.5818,8.4983,7.4152,8.0151,7.7322,7.7322,7.6458,7.5237,8.15,7.7409,8.3479,7.2186,8.8578,7.4496,9.1728,7.2101,9.5,7"
    style="stroke:#181818;stroke-width:0.5;"/><image height="48"
    width="45" x="17"
    xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAC0AAAAwCAIAAAAKMGSIAAABA0lEQVR42u2Z0Q3DIAxEsyIjMAIjdARGYARG6AiM0BG6QU9FQlEkiE0MJarvLwpOHuYi2c72XkPbWhwpJeec4QtRiBXj6IMoKGIc5pqUYwJHomk4BzFS/aEcyqEcN+Lw3j+bmsEhUl5c5Qgh4C52bMYImSZxiLinrXysDA4vrfzYGCOPQ9wTyqEcyqEcgzgeO/2Soxbwr/lQn67JUQtAbRZFdcLx2mlCPUY6l7yosIurfJLn9XrJCn0cwo2l9i9wRmMw1Jg4Du/nQIY6GxBlx8jwYY21ls3B8vkh27isGQhFObEN65xr48X2K3oKsbi4Uoyje/5cc24nRz4Lrhod+Sr/Gz6joejQ6zC0iQAAAABJRU5ErkJggg=="
    y="17"/><text fill="#000000" font-family="xkcd Script" font-size="14"
    lengthAdjust="spacing" textLength="10" x="36.5"
    y="80.2429">h1</text><text fill="#000000" font-family="xkcd Script"
    font-size="14" lengthAdjust="spacing" textLength="39" x="20"
    y="99.9017">10.0.0.1</text></g><g id="elem_h2"><polygon fill="#F1F1F1"
    points="621.5,7,621.5,7.2102,631.5,6.5857,641.5,7.1933,651.5,7.3997,661.5,6.2866,671.5,6.9223,681.5,7,681.4456,6.8687,681.8046,7.0283,682.1984,7.2719,682.4725,7.2264,682.9848,7.7563,683.2678,7.7322,683.0737,7.6518,683.3533,8.0606,683.6937,8.4944,683.6807,8.782,683.8746,9.1552,684,9.5,683.9681,9.5,684.1785,19.7318,684.2391,29.9635,684.5857,40.1953,684.6711,50.427,684.6793,60.6588,684.2546,70.8905,684.4636,81.1223,684.7022,91.354,683.2788,101.5858,684,111.8175,684.209,111.9041,683.7622,112.1332,683.8715,112.5927,683.4082,112.815,683.3931,113.223,683.2678,113.5853,683.3624,113.8137,682.908,113.7167,682.5741,113.9106,682.2503,114.1289,681.9066,114.2992,681.5,114.3175,681.5,114.3136,671.5,114.6047,661.5,113.7451,651.5,114.6019,641.5,114.8657,631.5,114.762,621.5,114.3175,621.5782,114.5063,621.0848,114.0223,620.7097,113.8238,620.3601,113.6868,620.0783,113.7136,619.7322,113.5853,619.6717,113.5602,619.7956,113.3186,619.3855,112.8559,619.1872,112.4809,619.2167,112.2002,619,111.8175,618.3332,111.8175,618.4809,101.5858,619.649,91.354,619.4357,81.1223,619.7345,70.8905,618.6782,60.6588,619.3192,50.427,619.5904,40.1953,618.5276,29.9635,618.9041,19.7318,619,9.5,619.0388,9.5161,619.3472,9.2296,619.2916,8.7924,619.5818,8.4983,619.4152,8.0151,619.7322,7.7322,619.6458,7.5237,620.15,7.7409,620.3479,7.2186,620.8578,7.4496,621.1728,7.2101,621.5,7"
    style="stroke:#181818;stroke-width:0.5;"/><image height="48"
    width="45" x="629"
    xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAC0AAAAwCAIAAAAKMGSIAAABA0lEQVR42u2Z0Q3DIAxEsyIjMAIjdARGYARG6AiM0BG6QU9FQlEkiE0MJarvLwpOHuYi2c72XkPbWhwpJeec4QtRiBXj6IMoKGIc5pqUYwJHomk4BzFS/aEcyqEcN+Lw3j+bmsEhUl5c5Qgh4C52bMYImSZxiLinrXysDA4vrfzYGCOPQ9wTyqEcyqEcgzgeO/2Soxbwr/lQn67JUQtAbRZFdcLx2mlCPUY6l7yosIurfJLn9XrJCn0cwo2l9i9wRmMw1Jg4Du/nQIY6GxBlx8jwYY21ls3B8vkh27isGQhFObEN65xr48X2K3oKsbi4Uoyje/5cc24nRz4Lrhod+Sr/Gz6joejQ6zC0iQAAAABJRU5ErkJggg=="
    y="17"/><text fill="#000000" font-family="xkcd Script" font-size="14"
    lengthAdjust="spacing" textLength="15" x="646"
    y="80.2429">h2</text><text fill="#000000" font-family="xkcd Script"
    font-size="14" lengthAdjust="spacing" textLength="44" x="629.5"
    y="99.9017">10.0.0.2</text></g><g id="elem_s1"><polygon fill="#F1F1F1"
    points="197.5,31.5,197.5,31.7102,208,31.0857,218.5,31.6933,229,31.8997,239.5,30.7866,250,31.4223,260.5,31.5,260.4456,31.3687,260.8046,31.5283,261.1984,31.7719,261.4725,31.7264,261.9848,32.2563,262.2678,32.2322,262.0737,32.1518,262.3533,32.5606,262.6937,32.9944,262.6807,33.282,262.8746,33.6552,263,34,262.9681,34,263.1785,44.5318,263.2391,55.0635,263.5857,65.5953,263.6711,76.127,263,86.6588,263.2092,86.7454,262.932,87.0448,262.8499,87.425,262.7769,87.809,262.1921,87.981,262.2678,88.4265,262.3543,88.6355,261.8764,88.4817,261.6288,88.8838,261.144,88.7134,260.8448,88.9912,260.5,89.1588,260.5,89.9004,250,89.11,239.5,89.2641,229,89.4974,218.5,89.575,208,89.1549,197.5,89.1588,197.5366,89.2472,197.0734,88.836,196.8292,88.9534,196.5093,88.8882,196.1425,88.7099,195.7322,88.4265,195.921,88.5047,195.437,88.0113,195.2385,87.6362,195.1015,87.2866,195.1283,87.0048,195,86.6588,194.8035,86.6588,195.6814,76.127,194.8253,65.5953,194.6569,55.0635,195.2283,44.5318,195,34,194.7946,33.9149,194.9866,33.5802,195.4927,33.3757,195.5735,32.9949,195.812,32.6795,195.7322,32.2322,195.6912,32.1331,196.1265,32.1841,196.5147,32.1212,196.7326,31.6474,197.1342,31.6169,197.5,31.5"
    style="stroke:#181818;stroke-width:0.5;"/><image height="18"
    width="48" x="205"
    xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAASCAIAAACSBMrtAAAAyElEQVR42s2V4RHDIAiFs2JGcARHcARHcARHYARHcIRuUC7cpZDCNVov+n4SHvkCaLbXYtrWBUop7ZPkvS+lCKAY4z5btdYPEA89L2oHNUkAqdkAoMbLoSGWnDO+nVw/gChVrTLccgsIh4h56iitz+2w3ALCipelOx/hoeDxEEK3ZQzQ96FttTjnekYGUrzzPM6n02Fp2yFMsq4DbMyl89yi7oplaQDCuhYQlsb7o8kSD/0F9IxMIJgkuqkVoLkSQLCAxM91Hb0BP+CVCm8acDEAAAAASUVORK5CYII="
    y="41.5"/><text fill="#000000" font-family="xkcd Script"
    font-size="14" lengthAdjust="spacing" textLength="9" x="226.5"
    y="74.7429">s1</text></g><g id="elem_s2"><polygon fill="#F1F1F1"
    points="430.5,31.5,430.5,31.7102,441,31.0857,451.5,31.6933,462,31.8997,472.5,30.7866,483,31.4223,493.5,31.5,493.4456,31.3687,493.8046,31.5283,494.1984,31.7719,494.4725,31.7264,494.9848,32.2563,495.2678,32.2322,495.0737,32.1518,495.3533,32.5606,495.6937,32.9944,495.6807,33.282,495.8746,33.6552,496,34,495.9681,34,496.1785,44.5318,496.2391,55.0635,496.5857,65.5953,496.6711,76.127,496,86.6588,496.2092,86.7454,495.932,87.0448,495.8499,87.425,495.7769,87.809,495.1921,87.981,495.2678,88.4265,495.3543,88.6355,494.8764,88.4817,494.6288,88.8838,494.144,88.7134,493.8448,88.9912,493.5,89.1588,493.5,89.9004,483,89.11,472.5,89.2641,462,89.4974,451.5,89.575,441,89.1549,430.5,89.1588,430.5366,89.2472,430.0734,88.836,429.8292,88.9534,429.5093,88.8882,429.1425,88.7099,428.7322,88.4265,428.921,88.5047,428.437,88.0113,428.2385,87.6362,428.1015,87.2866,428.1283,87.0048,428,86.6588,427.8035,86.6588,428.6814,76.127,427.8253,65.5953,427.6569,55.0635,428.2283,44.5318,428,34,427.7946,33.9149,427.9866,33.5802,428.4927,33.3757,428.5735,32.9949,428.812,32.6795,428.7322,32.2322,428.6912,32.1331,429.1265,32.1841,429.5147,32.1212,429.7326,31.6474,430.1342,31.6169,430.5,31.5"
    style="stroke:#181818;stroke-width:0.5;"/><image height="18"
    width="48" x="438"
    xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAASCAIAAACSBMrtAAAAyElEQVR42s2V4RHDIAiFs2JGcARHcARHcARHYARHcIRuUC7cpZDCNVov+n4SHvkCaLbXYtrWBUop7ZPkvS+lCKAY4z5btdYPEA89L2oHNUkAqdkAoMbLoSGWnDO+nVw/gChVrTLccgsIh4h56iitz+2w3ALCipelOx/hoeDxEEK3ZQzQ96FttTjnekYGUrzzPM6n02Fp2yFMsq4DbMyl89yi7oplaQDCuhYQlsb7o8kSD/0F9IxMIJgkuqkVoLkSQLCAxM91Hb0BP+CVCm8acDEAAAAASUVORK5CYII="
    y="41.5"/><text fill="#000000" font-family="xkcd Script"
    font-size="14" lengthAdjust="spacing" textLength="14" x="457"
    y="74.7429">s2</text></g><g id="link_h1_s1"><path d="M72.31,60.5 L72.31,60.7802
    L82.515,59.9476 L92.72,60.7577 L102.925,61.0329 L113.13,59.5488
    L123.335,60.3964 L133.54,59.9313 L143.745,59.9887 L153.95,60.4091
    L164.155,59.5782 L174.36,61.2382 L184.565,59.6596 L194.77,60.5 "
    fill="none" style="stroke:#181818;stroke-width:1.0;"/><text
    fill="#000000" font-family="xkcd Script" font-size="13"
    lengthAdjust="spacing" textLength="43" x="79.9473"
    y="75.9155">h1-eth0</text><text fill="#000000" font-family="xkcd
    Script" font-size="13" lengthAdjust="spacing" textLength="38"
    x="148.9518"
    y="76.02">s1-eth1</text></g><g id="link_s1_s2"><path d="M263.1,60.5 L263.1,60.7802
    L273.4038,59.9476 L283.7075,60.7577 L294.0113,61.0329 L304.315,59.5488
    L314.6188,60.3964 L324.9225,59.9313 L335.2263,59.9887 L345.53,60.4091
    L355.8338,59.5782 L366.1375,61.2382 L376.4412,59.6596 L386.745,60.2363
    L397.0488,61.0759 L407.3525,60.3856 L417.6563,60.591 L427.96,60.5 "
    fill="none" style="stroke:#181818;stroke-width:1.0;"/><text
    fill="#000000" font-family="xkcd Script" font-size="13"
    lengthAdjust="spacing" textLength="41" x="325" y="55.6543">10
    Gbps</text><text fill="#000000" font-family="xkcd Script"
    font-size="13" lengthAdjust="spacing" textLength="42" x="270.8484"
    y="75.9618">s1-eth2</text><text fill="#000000" font-family="xkcd
    Script" font-size="13" lengthAdjust="spacing" textLength="46"
    x="373.9387"
    y="75.9618">s2-eth2</text></g><g id="link_s2_h2"><path d="M496.09,60.5
    L496.09,60.7802 L506.3317,59.9476 L516.5733,60.7577 L526.815,61.0329
    L537.0567,59.5488 L547.2983,60.3964 L557.54,59.9313 L567.7817,59.9887
    L578.0233,60.4091 L588.265,59.5782 L598.5067,61.2382 L608.7483,59.6596
    L618.99,60.5 " fill="none"
    style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000"
    font-family="xkcd Script" font-size="13" lengthAdjust="spacing"
    textLength="42" x="503.837" y="75.9618">s2-eth1</text><text
    fill="#000000" font-family="xkcd Script" font-size="13"
    lengthAdjust="spacing" textLength="47" x="564.1136"
    y="75.9155">h2-eth0</text></g></g></svg>
    <figcaption>

      <span class="figure-number">&#1056;&#1080;&#1089;. 1.: </span>Лабораторная топология
    </figcaption>
    </figure>


### <span class="section-num">3.2</span> Рабочие файлы {#рабочие-файлы}

-   Подключимся к виртуальной машине:
    ```shell
    ssh -Y mininet@192.168.x.y
    ```
-   Для рабочих файлов будем использовать каталог `~/work/lab_tbf`:
    ```shell
    mkdir -p ~/work/lab_tbf
    ```


## <span class="section-num">4</span> Интерактивный эксперимент {#интерактивный-эксперимент}


### <span class="section-num">4.1</span> Отсутствие ограничения скорости {#отсутствие-ограничения-скорости}

-   Запустим iPerf3 в режиме сервера, выполните команду `iperf3 -s` в терминале хоста `h2`:
    ```shell
    iperf3 -s
    ```
-   Запустим iPerf3 в клиентском режиме, запустите команду `iperf3 -c 10.0.0.2` для хоста `h1`:
    ```shell
    iperf3 -c 10.0.0.2
    ```
-   Чтобы остановить сервер, нажмите `Ctrl+c` в терминале хоста `h2`.


### <span class="section-num">4.2</span> Ограничение скорости на конечных хостах {#ограничение-скорости-на-конечных-хостах}

-   Команду `tc` можно применить к сетевому интерфейсу устройства для формирования исходящего трафика.
-   Будем ограничивать скорость отправки конечного хоста с помощью фильтра Token Bucket Filter (tbf), который является реализацией алгоритма Token Bucket.


#### <span class="section-num">4.2.1</span> Определим интерфейс хостов `h1` и `h2` {#определим-интерфейс-хостов-h1-и-h2}

-   На хосте `h1` введите команду `ifconfig`, чтобы отобразить информацию, относящуюся к его сетевым интерфейсам и назначенным им IP-адресам.
    -   Хост `h1` имеет два интерфейса: `h1-eth0` и `lo`. Интерфейс `h1-eth0` на хосте `h1` настроен с IP-адресом 10.0.0.1 и маской подсети 255.0.0.0. Этот интерфейс необходимо использовать в `tc` при эмуляции сети.
-   В командной строке хоста `h2` также введите команду `ifconfig`.
    -   Хост `h2` имеет два интерфейса: `h2-eth0` и `lo`. Интерфейс `h2-eth0` на хосте `h1` настроен с IP-адресом 10.0.0.2 и маской подсети 255.0.0.0. Этот интерфейс необходимо использовать в `tc` при эмуляции сети.


#### <span class="section-num">4.2.2</span> Эмуляция глобальной сети 10 Гбит/с с высокой задержкой {#эмуляция-глобальной-сети-10-гбит-с-с-высокой-задержкой}

-   Будем использовать команду `tbf` на сетевом интерфейсе для управления скоростью исходящего трафика.
-   Измените пропускную способность хоста `h1`:
    ```shell
    sudo tc qdisc add dev h1-eth0 root tbf rate 10gbit burst 5000000 limit 15000000
    ```
-   Эта команда устанавливает пропускную способность на 10 Гбит/с на интерфейсе `h1-eth0` хоста `h1`.
-   Параметры Token Bucket Filter:
    -   rate : 10gbit;
    -   burst : 5,000,000;
    -   limit : 15,000,000.
-   Распишем элементы команды:
    -   `sudo` : включить выполнение команды с более высокими привилегиями безопасности;
    -   `tc` : вызвать управление трафиком Linux;
    -   `qdisc` : изменить дисциплину очередей сетевого планировщика;
    -   `add` (добавить): создать новое правило;
    -   `dev h1-eth0 root` : интерфейс, на котором будет применяться правило;
    -   `tbf` : использовать алгоритм Token Bucket Filter;
    -   `rate` : укажите скорость передачи (10 Гбит/с);
    -   `burst` : количество байтов, которое может поместиться в корзину (5 000 000) за один такт;
    -   `limit` : размер очереди в байтах (15 000 000).
-   Расчёт всплеска.
    -   `tbf` требует установки значения всплеска при ограничении скорости. Это значение должно быть достаточно высоким, чтобы обеспечить установленную вами скорость.
    -   Она должна быть не ниже указанной частоты, делённой на HZ, где HZ --- тактовая частота, настроенная как параметр ядра, и может быть извлечена с помощью следующей команды:
        ```shell
        egrep '^CONFIG_HZ_[0-9]+' /boot/config-`uname -r`
        ```
    -   HZ на `h1` --- 250. Таким образом, для расчёта всплеска делим 10 Гбит/с на 250:
        -   10 Gbps = 10,000,000,000 bps;
        -   burst = 10,000,000,000 [bps]/250 [s<sup>-1</sup>]  = 40,000,000 [bit] = 40,000,000/8 [byte] = 5,000,000 [byte].
    -   Полученное значение должно использоваться в команде в качестве значения _burst_ (всплеска).
-   Проверим конфигурацию с помощью инструмента `iperf3` для измерения пропускной способности.
-   Запустим iPerf3 в режиме сервера, выполните команду `iperf3 -s` в терминале хоста `h2`:
    ```shell
    iperf3 -s
    ```
-   Запустим iPerf3 в клиентском режиме, запустите команду `iperf3 -c 10.0.0.2` для хоста `h1`:
    ```shell
    iperf3 -c 10.0.0.2
    ```
-   Чтобы остановить сервер, нажмите `Ctrl+c` в терминале хоста `h2`.
-   Удалите конфигурацию на хосте `h1`:
    ```shell
    sudo tc qdisc del dev h1-eth0 root
    ```


### <span class="section-num">4.3</span> Ограничение скорости на коммутаторах {#ограничение-скорости-на-коммутаторах}

-   Применим Token Bucket Filter к интерфейсам коммутатора.
-   При ограничении скорости на интерфейсе `s1-eth2` коммутатора `s1` все сеансы связи между коммутатором `s1` и коммутатором `s2` будут фильтроваться в соответствии с применяемыми правилами.
-   Введите в терминале `s1` команду `ifconfig`, чтобы отобразить информацию, связанную с его сетевыми интерфейсами:
    -   `s1-eth1` : интерфейс, соединяющий коммутатор `s1` с хостом `h1`;
    -   `s1-eth2` : интерфейс, соединяющий коммутатор `s1` с коммутатором `s2`;
    -   `s2-eth1` : интерфейс, соединяющий коммутатор `s2` с хостом `h2`;
    -   `s2-eth2` : интерфейс, соединяющий коммутатор `s2` с коммутатором `s1`.
-   Примените правило ограничения скорости `tbf` к интерфейсу коммутатора `s1`, который соединяет его с коммутатором `s2` (`s1-eth2`):
    ```shell
    sudo tc qdisc add dev s1-eth2 root tbf rate 10gbit burst 5000000 limit 15000000
    ```

    -   Параметры Token Bucket Filter следующие:
        -   `rate` : 10gbit;
        -   `burst` : 5,000,000;
        -   `limit` : 15,000,000.
-   Проверим конфигурацию с помощью инструмента `iperf3` для измерения пропускной способности.
-   Запустим iPerf3 в режиме сервера, выполните команду `iperf3 -s` в терминале хоста `h2`:
    ```shell
    iperf3 -s
    ```
-   Запустим iPerf3 в клиентском режиме, запустите команду `iperf3 -c 10.0.0.2` для хоста `h1`:
    ```shell
    iperf3 -c 10.0.0.2
    ```
-   Чтобы остановить сервер, нажмите `Ctrl+c` в терминале хоста `h2`.
-   Удалите конфигурацию на коммутаторе `s1`:
    ```shell
    sudo tc qdisc del dev s1-eth2 root
    ```


### <span class="section-num">4.4</span> Объединение NETEM и TBF {#объединение-netem-и-tbf}

-   NETEM используется для введения задержки, джиттера, повреждения пакетов и т. д.
-   TBF может использоваться для ограничения скорости.
-   Возможно комбинировать несколько модулей.
-   Первый `qdisc` (`qdisc1`) присоединён к корневой метке. Затем последующие `qdisc` можно прикрепить к своим родителям, указав правильную метку.
-   Объединим NETEM и TBF, чтобы сделать эмуляцию адекватней. Введём задержку, джиттер и повреждение пакетов, указав скорость на интерфейсе коммутатора `s1`.
-   Введём в терминале коммутатора `s1`:
    ```shell
    sudo tc qdisc add dev s1-eth2 root handle 1: netem delay 10ms
    ```

    -   Ключевое слово `handle` задаёт дескриптор подключения, имеющий смысл очерёдности подключения разных дисциплин `qdisc`.
-   Теперь можно убедиться, что соединение от хоста `h1` к хосту `h2` имеет заданную задержку.
-   Запустите команду `ping` с терминала хоста `h1`:
    ```shell
    ping 10.0.0.2
    ```
-   Нажмите `Ctrl+c`, чтобы остановить тест.
-   Добавим второе правило на коммутаторе `s1`, которое задаёт ограничение скорости с помощью `tbf`:
    ```shell
    sudo tc qdisc add dev s1-eth2 parent 1: handle 2: tbf rate 2gbit burst 1000000 limit 2000000
    ```

    -   Параметры Token Bucket Filter следующие:
        -   `rate` : 2gbit;
        -   `burst` : 1,000,000;
        -   `limit` : 2,000,000.
-   Проверим предыдущую конфигурацию с помощью инструмента iperf3 для измерения пропускной способности.
-   Запустим iPerf3 в режиме сервера, выполните команду `iperf3 -s` в терминале хоста `h2`:
    ```shell
    iperf3 -s
    ```
-   Запустим iPerf3 в клиентском режиме, запустите команду `iperf3 -c 10.0.0.2` для хоста `h1`:
    ```shell
    iperf3 -c 10.0.0.2
    ```
-   Чтобы остановить сервер, нажмите `Ctrl+c` в терминале хоста `h2`.
-   Удалите конфигурацию на коммутаторе `s1`:
    ```shell
    sudo tc qdisc del dev s1-eth2 root
    ```


### <span class="section-num">4.5</span> Видео: Token Bucket Filter. Интерактивный эксперимент {#видео-token-bucket-filter-dot-интерактивный-эксперимент}

{{< tabs tabTotal="2" >}}
{{< rtab tabName="RuTube" >}}

{{< rutube 273ce5d8455a3ba7c18e99a0ce03ced4 >}}

{{< /rtab >}}
{{< rtab tabName="Youtube" >}}

{{< youtube ncCPgMUdgjM >}}

{{< /rtab >}}
{{< /tabs >}}
