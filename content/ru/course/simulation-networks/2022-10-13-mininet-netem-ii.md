---
title: "Mininet. Использование netem (потери пакетов)"
author: ["Dmitry S. Kulyabov"]
date: 2022-10-13T14:27:00+03:00
lastmod: 2022-10-17T10:22:00+03:00
tags: ["network", "education"]
categories: ["science", "computer-science"]
draft: false
weight: 204
slug: "mininet-netem-ii"
summary: "Использование netem (потери пакетов)"
toc: true
type: "book"
menu:
  "mininet-netem-ii":
    parent: "simulation-networks-lab"
    weight: 204
    identifier: "mininet-netem-ii"
---

Использование netem. Потери пакетов, дублирование пакетов, изменение порядка, повреждение пакетов.

<!--more-->

{{< toc >}}


## <span class="section-num">1</span> Общая информация {#общая-информация}


### <span class="section-num">1.1</span> Цели {#цели}

-   Освоить моделирование следующих параметров сети: потеря пакетов, дублирование пакетов, изменение порядка и повреждение пакетов.


### <span class="section-num">1.2</span> Задачи {#задачи}

-   В ходе работы требуется освоить следующие умения:
    -   эмуляция  сети, характеризующихся такими параметрами, как задержка, потеря пакетов, повреждение пакетов, переупорядочивание пакетов и дублирование пакетов;
    -   измерение производительности глобальных сетей, характеризующихся различными значениями параметров.


## <span class="section-num">2</span> Теоретические сведения {#теоретические-сведения}


### <span class="section-num">2.1</span> Проблемы с передачей пакетов {#проблемы-с-передачей-пакетов}

1.  Потеря пакета
    -   Пакет, проходящий через сеть, не достигает пункта назначения.
    -   Распространённой причиной потери пакетов является неспособность маршрутизаторов удерживать пакеты, поступающие со скоростью, превышающей скорость отправления.
    -   Маршрутизатор ограничен объёмом буферной памяти, используемой для мгновенного хранения пакетов.
    -   Когда происходит потеря пакетов, TCP уменьшает окно перегрузки и, следовательно, пропускную способность вдвое.
2.  Переупорядочивание пакетов
    -   Пакеты принимаются в порядке, отличном от того, в котором они были отправлены.
    -   Переупорядочивание пакетов (неупорядоченная доставка пакетов) обычно является результатом того, что пакеты следуют по разным маршрутам для достижения пункта назначения.
    -   Переупорядочивание пакетов может ухудшить пропускную способность TCP-соединений в сетях с высокой пропускной способностью и высокой задержкой.
    -   Для каждого сегмента, полученного не по порядку, получатель TCP отправляет подтверждение (ACK) для последнего правильно принятого сегмента.
    -   Как только отправитель TCP получает три подтверждения для одного и того же сегмента (тройной дубликат ACK), отправитель считает, что получатель неправильно принял пакет, следующий за пакетом, который подтверждается три раза.
    -   Тогда отправитель уменьшает окно перегрузки и пропускную способность в два раза.
3.  Повреждение пакета
    -   Повреждение битов, составляющих пакет.
    -   Обычно происходит на физическом уровне.
    -   В случае повреждения некоторые биты могут иметь значения, отличные от первоначально отправленных узлом-отправителем.
    -   Узел получателя отбрасывает такие пакеты.
    -   Процесс-отправитель TCP не получит подтверждения для соответствующего сегмента и будет считать его потерянным сегментом.
    -   Отправитель уменьшает окно перегрузки и пропускную способность в два раза.
4.  Дублирование пакетов
    -   Несколько копий пакета присутствуют в сети и принимаются пунктом назначения.
    -   Дублирование пакетов является результатом повторных передач, когда узел-отправитель повторно передает неподтвержденные (NACK) пакеты.


## <span class="section-num">3</span> Подготовка стенда {#подготовка-стенда}


### <span class="section-num">3.1</span> Лабораторная топология {#лабораторная-топология}

-   В топологии используется сеть 10.0.0.0/8, назначенная Mininet по умолчанию.
-   Топология представляет собой коммутатор с двумя подключёнными к нему хостами.
-   Для запуска топологии используем параметры командной строки:
    ```shell
    sudo mn --topo=single,2 -x
    ```


### <span class="section-num">3.2</span> Рабочие файлы {#рабочие-файлы}

-   Подключимся к виртуальной машине:
    ```shell
    ssh -Y mininet@192.168.x.y
    ```
-   Для рабочих файлов будем использовать каталог `~/work/lab_netem_ii`:
    ```shell
    mkdir -p ~/work/lab_netem_i
    ```


## <span class="section-num">4</span> Интерактивный эксперимент {#интерактивный-эксперимент}


### <span class="section-num">4.1</span> Добавление/изменение потери пакетов {#добавление-изменение-потери-пакетов}

-   Работа с NETEM осуществляется с помощью утилиты командной строки `tc`.
-   Без дополнительных параметров NETEM ведёт себя как базовая очередь FIFO без задержек, потерь, дублирования или переупорядочения пакетов.
-   Основной синтаксис `tc`, используемый с NETEM, следующий:
    ```shell
    sudo tc qdisc [add|del|replace|change|show] dev dev_id root netem opts
    ```

    -   `sudo`: выполнить команду с более высокими привилегиями;
    -   `tc`: команда, используемая для взаимодействия с NETEM;
    -   `qdisc`: дисциплина очереди (`qdisc`) представляет собой набор правил, определяющих порядок, в котором обслуживаются пакеты, поступающие по  протоколу IP.
        -   Дисциплина очереди применяется к очереди пакетов, чтобы решить, когда отправлять каждый пакет.
    -   `[add|del|replace|change|show]` (добавить, удалить, заменить, изменить, показать): операция над `qdisc`:
        -   чтобы добавить задержку на определённом интерфейсе, применяется операция `add`;
        -   чтобы изменить или удалить задержку на определённом интерфейсе, применяется операция `change` или `del`;
    -   `dev_id`: параметр указывает интерфейс, подлежащий эмуляции;
    -   `opts`: параметр указывает величину задержки, потери пакетов, дублирования, повреждения и другие.


### <span class="section-num">4.2</span> Определение интерфейсов хостов `h1` и `h2` {#определение-интерфейсов-хостов-h1-и-h2}

-   Необходимо идентифицировать интерфейсы на подключенных хостах.
-   На хосте `h1` введите команду `ifconfig`, чтобы отобразить информацию, относящуюся к его сетевым интерфейсам и назначенным им IP-адресам.
    -   Вывод команды `ifconfig` показывает, что хост `h1` имеет два интерфейса: `h1-eth0` и `lo`.
    -   Интерфейс `h1-eth0` необходимо использовать в `tc` при эмуляции WAN.
-   На хосте `h2` введите команду `ifconfig`.
-   Вывод команды `ifconfig` показывает, что хост `h2` имеет два интерфейса: `h2-eth0` и `lo`.
-   Интерфейс `h2-eth0` необходимо использовать в `tc` при эмуляции WAN.


### <span class="section-num">4.3</span> Добавка потери пакетов на интерфейс, подключённый к глобальной сети {#добавка-потери-пакетов-на-интерфейс-подключённый-к-глобальной-сети}

-   Пакеты могут быть потеряны во время передачи из-за таких факторов, как битовые ошибки и перегрузка сети.
-   Скорость потерянных пакетов часто измеряется как процентная доля потерянных пакетов по отношению к количеству отправленных пакетов.
-   В терминале хоста `h1` введите следующую команду:
    ```shell
    sudo tc qdisc add dev h1-eth0 root netem loss 10%
    ```
-   Эта команда добавляет 10% потери пакетов к интерфейсу `h1-eth0` хоста `h1`.
-   Теперь можно проверить наличие потерь пакетов, используя команду `ping` с терминала хоста `h1`. Параметр `-c` указывает общее количество пакетов для отправки:
    ```shell
    ping 10.0.0.2 -c 200
    ```
-   Обратите внимание на значения `icmp_seq`. Некоторые номера последовательности отсутствуют из-за потери пакетов.
-   В сводном отчёте `ping` сообщает о проценте потерянных пакетов после завершения передачи.
-   Данный сценарий эмулирует 10% потери пакетов в однонаправленном канале от хоста `h1` к хосту `h2`.
-   Если мы хотим эмулировать потерю пакетов в обоих направлениях, к хосту `h2` также необходимо добавить потерю пакетов в размере 10%.
-   В терминале хоста `h2` введите следующую команду:
    ```shell
    sudo tc qdisc add dev h2-eth0 root netem loss 10%
    ```
-   Можно убедиться, что соединение между хостом `h1` и хостом `h2` имеет больше потерь пакетов (10% от хоста `h1` + 10% от хоста `h2`), повторив команду `ping` на терминале хоста `h1`:
    ```shell
    ping 10.0.0.2 -c 200
    ```
-   Обратите внимание на значения `icmp_seq`. Некоторые номера последовательности отсутствуют из-за потери пакетов.
-   В сводном отчёте `ping` сообщает о проценте потерянных пакетов после завершения передачи.
-   Чтобы удалить добавленную потерю пакетов и восстановить конфигурацию по умолчанию, необходимо удалить правила интерфейсов на хосте `h1` и хосте `h2`.
-   В терминале хоста `h1` введите следующую команду:
    ```shell
    sudo tc qdisc del dev h1-eth0 root netem
    ```
-   Примените те же действия для удаления правил на хосте `h2`. В терминале хоста `h2` введите следующую команду:
    ```shell
    sudo tc qdisc del dev h2-eth0 root netem
    ```
-   В результате дисциплина организации очереди tc восстановит свои значения по умолчанию.
-   Теперь можно убедиться, что соединение от хоста `h1` к хосту `h2` не имеет явной потери пакетов.
-   Запустите команду `ping` с терминала хоста `h1`, нажмите `Ctrl+c`, чтобы остановить тест:
    ```shell
    ping 10.0.0.2
    ```


### <span class="section-num">4.4</span> Добавка значения корреляции для потери пакетов {#добавка-значения-корреляции-для-потери-пакетов}

-   Можно добавить необязательную корреляцию.
-   В терминале хоста `h1` введите следующую команду:
    ```shell
    sudo tc qdisc add dev h1-eth0 root netem loss 50% 50%
    ```
-   Команда вводит коэффициент потери пакетов 50% (такой высокий уровень потери пакетов маловероятен), и каждая последующая вероятность зависит на 50% от последней.
-   Теперь пользователь может проверить, что между хостом `h1` и хостом `h2` теряются пакеты, используя команду `ping` с терминала хоста `h1`:
    ```shell
    ping 10.0.0.2 -c 50
    ```
-   Обратите внимание на значения `icmp_seq`. Некоторые номера последовательности отсутствуют из-за потери пакетов.
-   В сводном отчёте `ping` сообщает о проценте потерянных пакетов после завершения передачи.
-   В терминале хоста `h1` введите следующую команду, чтобы удалить предыдущие конфигурации:
    ```shell
    sudo tc qdisc del dev h1-eth0 root netem
    ```


### <span class="section-num">4.5</span> Добавка повреждения пакетов {#добавка-повреждения-пакетов}

-   Помимо потери пакетов, с помощью NETEM можно эмулировать повреждение пакетов.
-   В терминале хоста `h1` введите следующую команду:
    ```shell
    sudo tc qdisc add dev h1-eth0 root netem corrupt 0.01%
    ```
-   Добавленное здесь новое значение представляет собой процент повреждения пакетов (0,01%).
-   Теперь пользователь может проверить предыдущую конфигурацию с помощью инструмента `iperf3` для проверки повторных передач.
-   Запустите iPerf3 в режиме сервера в терминале хоста `h2`:
    ```shell
    iperf3 -s
    ```
-   Запустите iPerf3 в клиентском режиме в терминале хоста `h1`:
    ```shell
    iperf3 -c 10.0.0.2
    ```
-   Посмотрите значения повторной передачи на каждом временном интервале и общее количество повторно переданных пакетов.
-   В терминале хоста `h1` введите следующую команду, чтобы удалить предыдущие конфигурации:
    ```shell
    sudo tc qdisc del dev h1-eth0 root netem
    ```
-   Чтобы остановить сервер, нажмите `Ctrl+c` в терминале хоста `h2`.


### <span class="section-num">4.6</span> Добавка переупорядочивание пакетов {#добавка-переупорядочивание-пакетов}

-   Иногда пакеты доставляются не в том порядке, в котором они были отправлены.
-   Для эмуляции переупорядочивания в NETEM используется опция переупорядочивания.
-   В терминале хоста `h1` введите следующую команду:
    ```shell
    sudo tc qdisc add dev h1-eth0 root netem delay 10ms reorder 25% 50%
    ```
-   В этой команде 25% пакетов (со значением корреляции 50%) будут отправлены немедленно, а остальные 75% будут задержаны на 10 мс.
-   Пользователь может проверить эффект переупорядочивания пакетов с помощью команды `ping` на терминале хоста `h1` (нажмите `Ctrl+c`, чтобы остановить тест):
    ```shell
    ping 10.0.0.2
    ```
-   Первый и второй пакеты не будут иметь задержки (один из четырех, или 25%), а следующие три пакета будут иметь задержку около 10 миллисекунд (три из четырех, или 75%).
-   В терминале хоста `h1` введите следующую команду, чтобы удалить предыдущие конфигурации:
    ```shell
    sudo tc qdisc del dev h1-eth0 root netem
    ```


### <span class="section-num">4.7</span> Добавка дублирования пакетов {#добавка-дублирования-пакетов}

-   Дублированные пакеты могут присутствовать в сетях в результате повторных передач.
-   NETEM предоставляет возможность эмуляции дублирования пакетов.
-   В терминале хоста `h1` введите следующую команду:
    ```shell
    sudo tc qdisc change dev h1-eth0 root netem duplicate 50%
    ```
-   Команда создаст дублирование 50% (т. е. 50% пакетов будут получены дважды).
-   Пользователь может проверить эффект дублирования пакетов с помощью команды `ping` на терминале хоста `h1` (нажмите `Ctrl+c`, чтобы остановить тест):
    ```shell
    ping 10.0.0.2
    ```
-   Дубликаты пакетов помечаются как `DUP!`.
-   Измеренная скорость дублирования пакетов будет приближаться к настроенной скорости по мере выполнения большего количества попыток.
-   В терминале хоста `h1` введите следующую команду, чтобы удалить предыдущие конфигурации:
    ```shell
    sudo tc qdisc del dev h1-eth0 root netem
    ```
